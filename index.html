<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Toolkit Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4bb543;
            --warning-color: #ff9500;
            --danger-color: #ff3b30;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f5f7ff;
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            box-shadow: var(--box-shadow);
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        header h1 i {
            font-size: 1.8rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        nav {
            background-color: var(--secondary-color);
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .nav-container::-webkit-scrollbar {
            height: 6px;
        }

        .nav-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 3px;
        }

        nav button {
            background-color: transparent;
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav button:hover, nav button.active {
            background-color: rgba(255, 255, 255, 0.15);
        }

        nav button i {
            font-size: 0.9rem;
        }

        main {
            flex-grow: 1;
            padding: 2rem 1rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .tool-section {
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background-color: white;
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }

        .tool-section h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tool-section h2 i {
            font-size: 1.3rem;
            color: var(--secondary-color);
        }

        .tool-section p.description {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 1.5rem;
            line-height: 1.7;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark-color);
        }

        input[type="file"], 
        input[type="text"], 
        input[type="number"], 
        input[type="password"], 
        select, 
        textarea {
            display: block;
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: var(--transition);
        }

        input[type="file"] {
            padding: 0.5rem;
            background-color: var(--light-color);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
        }

        .input-group > * {
            flex: 1;
        }

        button.action-button {
            background-color: var(--primary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button.action-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        button.action-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.action-button.secondary {
            background-color: #6c757d;
        }

        button.action-button.secondary:hover {
            background-color: #5a6268;
        }

        button.action-button.danger {
            background-color: var(--danger-color);
        }

        button.action-button.danger:hover {
            background-color: #e0352b;
        }

        button.action-button.success {
            background-color: var(--success-color);
        }

        button.action-button.success:hover {
            background-color: #3fa337;
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-message i {
            font-size: 1.1rem;
        }

        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .status-message.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .status-message.warning {
            background-color: #fff8e1;
            color: #e65100;
            border: 1px solid #ffcc80;
        }

        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.75rem;
            border: 1px dashed #ddd;
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
        }

        .image-preview-container img {
            max-width: 120px;
            max-height: 120px;
            border: 1px solid #eee;
            border-radius: 4px;
            object-fit: contain;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        textarea {
            min-height: 150px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .button-group button {
            flex: 1;
        }

        .page-thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }

        .page-thumbnail {
            position: relative;
            width: 120px;
            cursor: move;
        }

        .page-thumbnail img {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .page-thumbnail .page-number {
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px 0 4px 0;
        }

        .page-thumbnail .page-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.3rem;
            background-color: rgba(0,0,0,0.5);
            border-radius: 0 0 4px 4px;
        }

        .page-thumbnail .page-actions button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.2rem;
        }

        .page-thumbnail .page-actions button:hover {
            color: var(--accent-color);
        }

        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            background-color: var(--dark-color);
            color: #f8f9fa;
            font-size: 0.9rem;
        }

        footer p {
            margin: 0.5rem 0;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .footer-links a {
            color: #adb5bd;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--accent-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5rem;
            }
            
            .header-subtitle {
                font-size: 0.8rem;
            }
            
            .tool-section {
                padding: 1.25rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .input-group {
                flex-direction: column;
            }
        }

        /* Drag and drop styling */
        .dropzone {
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            background-color: rgba(67, 97, 238, 0.05);
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .dropzone.active {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--secondary-color);
        }

        .dropzone p {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .dropzone i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        /* Tooltip styling */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Advanced options toggle */
        .advanced-options {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }

        .toggle-advanced {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .toggle-advanced i {
            transition: transform 0.3s ease;
        }

        .toggle-advanced.collapsed i {
            transform: rotate(-90deg);
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin: 1rem 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: var(--secondary-color);
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
        }
        a {
            color: #1565c0;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-file-pdf"></i> PDF Toolkit Pro</h1>
        <p class="header-subtitle">Powerful PDF tools that work entirely in your browser - no uploads, no server processing</p>
    </header>
    <nav>
        <div class="nav-container" id="tool-navigation">
            <!-- Tool buttons will be inserted here by JavaScript -->
        </div>
    </nav>
    <main id="tool-container">
        <div class="welcome-message">
            <div class="tool-section">
                <h2><i class="fas fa-hand-wave"></i> Welcome to PDF Toolkit Pro!</h2>
                <p class="description">Select a tool from the navigation above to get started. All processing happens in your browser - your files never leave your computer.</p>
                <div class="feature-grid">
                    <div class="feature">
                        <i class="fas fa-lock"></i>
                        <h3>100% Private</h3>
                        <p>No file uploads - all processing happens in your browser</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-bolt"></i>
                        <h3>Fast Processing</h3>
                        <p>Optimized tools that work quickly even with large files</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-tools"></i>
                        <h3>Powerful Tools</h3>
                        <p>Everything you need to work with PDFs and images</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-desktop"></i>
                        <h3>No Installation</h3>
                        <p>Works on any device with a modern web browser</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 PDF Toolkit Pro - All Rights Reserved</p>
        <p>Made With &hearts; By <a href="https://sawwqib.vercel.app">Saqib</a></p>
        <div class="footer-links">
            <a href="https://sawwqib.vercel.app"><i class="fas fa-envelope"></i> Contact</a>
            <a href="https://github.com/sawwqib"><i class="fab fa-github"></i> GitHub</a>
        </div>
    </footer>

    <!-- CDN Libraries -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
    // --- Main Application Logic ---
    (async () => {
        const { PDFDocument, rgb, StandardFonts, degrees } = PDFLib; // pdf-lib
        // Tesseract.js is globally available as Tesseract
        // pdfjsLib is globally available for PDF.js
        // download is globally available from download.js
        // Sortable is globally available for drag and drop

        const toolContainer = document.getElementById('tool-container');
        const toolNavigation = document.getElementById('tool-navigation');
        let currentTool = null;
        let tesseractWorker = null; // For OCR, create worker once
        let sortableInstance = null; // For page reordering

        // --- Utility Functions ---
        function showStatus(message, type = 'info', toolUiId) {
            const statusDiv = document.getElementById(`${toolUiId}-status`) || document.createElement('div');
            if (!statusDiv.id) { // if newly created
                statusDiv.id = `${toolUiId}-status`;
                statusDiv.className = `status-message ${type}`;
                const toolElement = document.getElementById(toolUiId);
                if (toolElement) toolElement.appendChild(statusDiv);
            }
            
            // Clear previous content
            statusDiv.innerHTML = '';
            
            // Add icon based on type
            let iconClass;
            switch(type) {
                case 'success': iconClass = 'fas fa-check-circle'; break;
                case 'error': iconClass = 'fas fa-exclamation-circle'; break;
                case 'warning': iconClass = 'fas fa-exclamation-triangle'; break;
                default: iconClass = 'fas fa-info-circle';
            }
            
            const icon = document.createElement('i');
            icon.className = iconClass;
            statusDiv.appendChild(icon);
            
            // Add message text
            const text = document.createElement('span');
            text.textContent = message;
            statusDiv.appendChild(text);
            
            statusDiv.className = `status-message ${type}`;
        }

        function showLoader(toolUiId, show = true) {
            const loader = document.getElementById(`${toolUiId}-loader`);
            if (loader) loader.style.display = show ? 'block' : 'none';
        }

        function disableButton(buttonId, disable = true) {
            const button = document.getElementById(buttonId);
            if (button) button.disabled = disable;
        }

        function updateProgressBar(toolUiId, percent) {
            const progressBar = document.getElementById(`${toolUiId}-progress`);
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
        }

        function createDropzone(elementId, callback) {
            const dropzone = document.getElementById(elementId);
            if (!dropzone) return;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropzone.classList.add('active');
            }
            
            function unhighlight() {
                dropzone.classList.remove('active');
            }
            
            dropzone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                callback(files);
            }
        }

        async function initializeTesseract() {
            if (!tesseractWorker) {
                showStatus('Initializing OCR engine (this may take a moment)...', 'info', currentTool);
                tesseractWorker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            showStatus(`OCR: ${m.status} ${Math.round(m.progress * 100)}%`, 'info', currentTool);
                            updateProgressBar(`${currentTool}-progress`, m.progress * 100);
                        } else if(m.status === 'loading language model'){
                            showStatus(`OCR: Loading language data...`, 'info', currentTool);
                        } else {
                            console.log('Tesseract:', m);
                        }
                    }
                });
                await tesseractWorker.loadLanguage('eng');
                await tesseractWorker.initialize('eng');
                showStatus('OCR engine ready.', 'success', currentTool);
            }
            return tesseractWorker;
        }

        // --- Tool Definitions ---
        const tools = {
            'merge-pdf': {
                name: 'Merge PDF',
                icon: 'fa-file-pdf',
                description: 'Combine multiple PDF files into a single document. Drag and drop files to reorder them before merging.',
                initUI: () => `
                    <div class="tool-section" id="merge-pdf-ui">
                        <h2><i class="fas fa-file-pdf"></i> Merge PDF</h2>
                        <p class="description">${tools['merge-pdf'].description}</p>
                        
                        <div class="dropzone" id="merge-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop PDF files here</p>
                            <p>or</p>
                            <label for="mergeFiles" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select Files
                            </label>
                            <input type="file" id="mergeFiles" multiple accept=".pdf" style="display: none;">
                        </div>
                        
                        <div id="merge-file-list" style="margin: 1rem 0;"></div>
                        
                        <div class="button-group">
                            <button id="mergeButton" class="action-button">
                                <i class="fas fa-object-group"></i> Merge PDFs
                            </button>
                            <button id="clearMergeButton" class="action-button secondary">
                                <i class="fas fa-trash-alt"></i> Clear
                            </button>
                        </div>
                        
                        <div class="loader" id="merge-pdf-ui-loader"></div>
                        <div id="merge-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('mergeFiles');
                    const fileList = document.getElementById('merge-file-list');
                    let files = [];
                    
                    // Handle file selection via button
                    fileInput.addEventListener('change', () => {
                        if (fileInput.files.length > 0) {
                            files = Array.from(fileInput.files);
                            updateFileList();
                        }
                    });
                    
                    // Handle drag and drop
                    createDropzone('merge-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            files = Array.from(droppedFiles);
                            updateFileList();
                        }
                    });
                    
                    // Update the file list display
                    function updateFileList() {
                        fileList.innerHTML = '';
                        
                        if (files.length === 0) {
                            fileList.innerHTML = '<p>No files selected</p>';
                            return;
                        }
                        
                        const list = document.createElement('div');
                        list.className = 'page-thumbnails';
                        
                        files.forEach((file, index) => {
                            const item = document.createElement('div');
                            item.className = 'page-thumbnail';
                            item.draggable = true;
                            item.dataset.index = index;
                            
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.alt = `Page ${index + 1}`;
                                img.style.maxHeight = '100px';
                                
                                const pageNum = document.createElement('div');
                                pageNum.className = 'page-number';
                                pageNum.textContent = `#${index + 1}`;
                                
                                const fileName = document.createElement('div');
                                fileName.className = 'file-name';
                                fileName.textContent = file.name.length > 20 ? 
                                    file.name.substring(0, 17) + '...' : file.name;
                                fileName.style.fontSize = '0.7rem';
                                fileName.style.marginTop = '0.3rem';
                                fileName.style.textAlign = 'center';
                                
                                item.appendChild(pageNum);
                                item.appendChild(img);
                                item.appendChild(fileName);
                                
                                item.addEventListener('dragstart', (e) => {
                                    e.dataTransfer.setData('text/plain', index);
                                });
                                
                                item.addEventListener('dragover', (e) => {
                                    e.preventDefault();
                                });
                                
                                item.addEventListener('drop', (e) => {
                                    e.preventDefault();
                                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                                    const toIndex = index;
                                    if (fromIndex !== toIndex) {
                                        const fileToMove = files[fromIndex];
                                        files.splice(fromIndex, 1);
                                        files.splice(toIndex, 0, fileToMove);
                                        updateFileList();
                                    }
                                });
                            };
                            
                            // For PDF files, we'll just show a generic PDF icon
                            if (file.type === 'application/pdf') {
                                item.innerHTML = `
                                    <div class="page-number">#${index + 1}</div>
                                    <i class="fas fa-file-pdf" style="font-size: 3rem; color: #e74c3c; display: block; text-align: center; padding: 1rem 0;"></i>
                                    <div style="font-size: 0.7rem; margin-top: 0.3rem; text-align: center;">
                                        ${file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name}
                                    </div>
                                `;
                                
                                item.addEventListener('dragstart', (e) => {
                                    e.dataTransfer.setData('text/plain', index);
                                });
                                
                                item.addEventListener('dragover', (e) => {
                                    e.preventDefault();
                                });
                                
                                item.addEventListener('drop', (e) => {
                                    e.preventDefault();
                                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                                    const toIndex = index;
                                    if (fromIndex !== toIndex) {
                                        const fileToMove = files[fromIndex];
                                        files.splice(fromIndex, 1);
                                        files.splice(toIndex, 0, fileToMove);
                                        updateFileList();
                                    }
                                });
                            } else {
                                reader.readAsDataURL(file);
                            }
                            
                            list.appendChild(item);
                        });
                        
                        fileList.appendChild(list);
                    }
                    
                    // Clear button
                    document.getElementById('clearMergeButton').addEventListener('click', () => {
                        files = [];
                        fileInput.value = '';
                        updateFileList();
                        showStatus('File list cleared.', 'info', 'merge-pdf-ui');
                    });
                    
                    // Merge button
                    document.getElementById('mergeButton').addEventListener('click', async () => {
                        if (files.length < 2) {
                            showStatus('Please select at least two PDF files.', 'error', 'merge-pdf-ui');
                            return;
                        }
                        
                        showLoader('merge-pdf-ui', true);
                        disableButton('mergeButton', true);
                        showStatus('Merging PDFs...', 'info', 'merge-pdf-ui');
                        
                        try {
                            const mergedPdf = await PDFDocument.create();
                            let processedCount = 0;
                            
                            for (const file of files) {
                                try {
                                    const arrayBuffer = await file.arrayBuffer();
                                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                                    const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                                    copiedPages.forEach(page => mergedPdf.addPage(page));
                                    
                                    processedCount++;
                                    updateProgressBar('merge-pdf-ui-progress', (processedCount / files.length) * 100);
                                } catch (e) {
                                    console.error(`Error processing file ${file.name}:`, e);
                                    showStatus(`Error processing ${file.name}: ${e.message}`, 'error', 'merge-pdf-ui');
                                    continue;
                                }
                            }
                            
                            const mergedPdfBytes = await mergedPdf.save();
                            download(mergedPdfBytes, "merged.pdf", "application/pdf");
                            showStatus('PDFs merged successfully! Download started.', 'success', 'merge-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error merging PDFs: ${e.message}`, 'error', 'merge-pdf-ui');
                        } finally {
                            showLoader('merge-pdf-ui', false);
                            disableButton('mergeButton', false);
                        }
                    });
                }
            },
            'split-pdf': {
                name: 'Split PDF',
                icon: 'fa-cut',
                description: 'Extract specific pages or page ranges from a PDF file. You can split by page numbers or extract every page as a separate file.',
                initUI: () => `
                    <div class="tool-section" id="split-pdf-ui">
                        <h2><i class="fas fa-cut"></i> Split PDF</h2>
                        <p class="description">${tools['split-pdf'].description}</p>
                        
                        <div class="dropzone" id="split-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="splitFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="splitFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="splitMode">Split Mode:</label>
                            <select id="splitMode" class="form-control">
                                <option value="range">Extract Page Range</option>
                                <option value="single">Extract Single Pages</option>
                                <option value="every">Extract Every Page</option>
                            </select>
                        </div>
                        
                        <div id="rangeInputs">
                            <div class="form-group">
                                <label for="pageRanges">Page ranges (e.g., 1-3, 5, 7-end):</label>
                                <input type="text" id="pageRanges" placeholder="e.g., 1-3, 5, 7-end">
                            </div>
                        </div>
                        
                        <div id="singleInputs" style="display: none;">
                            <div class="form-group">
                                <label for="singlePages">Page numbers (comma separated):</label>
                                <input type="text" id="singlePages" placeholder="e.g., 1,3,5">
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button id="splitButton" class="action-button">
                                <i class="fas fa-cut"></i> Split PDF
                            </button>
                            <button id="previewPagesButton" class="action-button secondary">
                                <i class="fas fa-eye"></i> Preview Pages
                            </button>
                        </div>
                        
                        <div id="pagePreviewContainer" class="image-preview-container" style="display: none;"></div>
                        
                        <div class="loader" id="split-pdf-ui-loader"></div>
                        <div id="split-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('splitFile');
                    const splitMode = document.getElementById('splitMode');
                    const rangeInputs = document.getElementById('rangeInputs');
                    const singleInputs = document.getElementById('singleInputs');
                    const previewContainer = document.getElementById('pagePreviewContainer');
                    
                    // Handle drag and drop
                    createDropzone('split-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'split-pdf-ui');
                        }
                    });
                    
                    // Handle split mode change
                    splitMode.addEventListener('change', () => {
                        if (splitMode.value === 'range') {
                            rangeInputs.style.display = 'block';
                            singleInputs.style.display = 'none';
                        } else if (splitMode.value === 'single') {
                            rangeInputs.style.display = 'none';
                            singleInputs.style.display = 'block';
                        } else {
                            rangeInputs.style.display = 'none';
                            singleInputs.style.display = 'none';
                        }
                    });
                    
                    // Preview pages button
                    document.getElementById('previewPagesButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file first.', 'error', 'split-pdf-ui');
                            return;
                        }
                        
                        showLoader('split-pdf-ui', true);
                        disableButton('previewPagesButton', true);
                        showStatus('Generating page previews...', 'info', 'split-pdf-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            const numPages = pdf.numPages;
                            previewContainer.innerHTML = '';
                            
                            // Limit to first 10 pages for preview
                            const previewPageCount = Math.min(numPages, 10);
                            
                            for (let i = 1; i <= previewPageCount; i++) {
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale: 0.5 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                
                                const img = document.createElement('img');
                                img.src = canvas.toDataURL('image/jpeg', 0.7);
                                img.alt = `Page ${i}`;
                                img.title = `Page ${i}`;
                                
                                const pageDiv = document.createElement('div');
                                pageDiv.style.textAlign = 'center';
                                pageDiv.appendChild(img);
                                pageDiv.innerHTML += `<div style="font-size: 0.8rem; margin-top: 0.3rem;">Page ${i}</div>`;
                                
                                previewContainer.appendChild(pageDiv);
                                canvas.remove();
                            }
                            
                            if (numPages > 10) {
                                previewContainer.innerHTML += `<div style="text-align: center; font-style: italic;">+ ${numPages - 10} more pages...</div>`;
                            }
                            
                            previewContainer.style.display = 'flex';
                            showStatus(`Preview generated for first ${previewPageCount} pages.`, 'success', 'split-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error generating preview: ${e.message}`, 'error', 'split-pdf-ui');
                        } finally {
                            showLoader('split-pdf-ui', false);
                            disableButton('previewPagesButton', false);
                        }
                    });
                    
                    // Split button
                    document.getElementById('splitButton').addEventListener('click', async () => {
                        const file = fileInput.files[0];
                        if (!file) {
                            showStatus('Please select a PDF file.', 'error', 'split-pdf-ui');
                            return;
                        }
                        
                        showLoader('split-pdf-ui', true);
                        disableButton('splitButton', true);
                        showStatus('Processing PDF...', 'info', 'split-pdf-ui');
                        
                        try {
                            const arrayBuffer = await file.arrayBuffer();
                            const pdfDoc = await PDFDocument.load(arrayBuffer);
                            const totalPages = pdfDoc.getPageCount();
                            const fileBaseName = file.name.replace(/\.pdf$/i, '');
                            
                            let pageIndicesToExtract = [];
                            
                            if (splitMode.value === 'range') {
                                const rangesInput = document.getElementById('pageRanges').value.trim();
                                if (!rangesInput) {
                                    throw new Error('Please enter page ranges.');
                                }
                                
                                const ranges = rangesInput.split(',');
                                for (const range of ranges) {
                                    const trimmedRange = range.trim();
                                    if (trimmedRange.includes('-')) {
                                        let [start, end] = trimmedRange.split('-');
                                        start = parseInt(start, 10);
                                        end = (end.toLowerCase() === 'end') ? totalPages : parseInt(end, 10);
                                        if (isNaN(start) || isNaN(end) || start < 1 || end > totalPages || start > end) {
                                            throw new Error(`Invalid range: ${trimmedRange}. Max page is ${totalPages}.`);
                                        }
                                        for (let i = start; i <= end; i++) {
                                            pageIndicesToExtract.push(i - 1); // 0-indexed
                                        }
                                    } else {
                                        const pageNum = parseInt(trimmedRange, 10);
                                        if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
                                            throw new Error(`Invalid page number: ${trimmedRange}. Max page is ${totalPages}.`);
                                        }
                                        pageIndicesToExtract.push(pageNum - 1); // 0-indexed
                                    }
                                }
                            } 
                            else if (splitMode.value === 'single') {
                                const pagesInput = document.getElementById('singlePages').value.trim();
                                if (!pagesInput) {
                                    throw new Error('Please enter page numbers.');
                                }
                                
                                const pages = pagesInput.split(',');
                                for (const pageStr of pages) {
                                    const pageNum = parseInt(pageStr.trim(), 10);
                                    if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
                                        throw new Error(`Invalid page number: ${pageStr}. Max page is ${totalPages}.`);
                                    }
                                    pageIndicesToExtract.push(pageNum - 1); // 0-indexed
                                }
                            }
                            else if (splitMode.value === 'every') {
                                for (let i = 0; i < totalPages; i++) {
                                    pageIndicesToExtract.push(i);
                                }
                            }
                            
                            const uniqueSortedIndices = [...new Set(pageIndicesToExtract)].sort((a, b) => a - b);
                            if (!uniqueSortedIndices.length) {
                                throw new Error('No valid pages selected for extraction.');
                            }
                            
                            if (splitMode.value === 'every') {
                                // Extract each page as a separate PDF
                                for (const pageIndex of uniqueSortedIndices) {
                                    const newPdfDoc = await PDFDocument.create();
                                    const [copiedPage] = await newPdfDoc.copyPages(pdfDoc, [pageIndex]);
                                    newPdfDoc.addPage(copiedPage);
                                    const newPdfBytes = await newPdfDoc.save();
                                    download(newPdfBytes, `${fileBaseName}_page_${pageIndex + 1}.pdf`, "application/pdf");
                                }
                                showStatus(`Extracted ${uniqueSortedIndices.length} pages as separate files.`, 'success', 'split-pdf-ui');
                            } else {
                                // Extract selected pages as one PDF
                                const newPdfDoc = await PDFDocument.create();
                                const copiedPages = await newPdfDoc.copyPages(pdfDoc, uniqueSortedIndices);
                                copiedPages.forEach(page => newPdfDoc.addPage(page));
                                const newPdfBytes = await newPdfDoc.save();
                                download(newPdfBytes, `${fileBaseName}_extracted.pdf`, "application/pdf");
                                showStatus(`Extracted ${uniqueSortedIndices.length} pages successfully! Download started.`, 'success', 'split-pdf-ui');
                            }
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error splitting PDF: ${e.message}`, 'error', 'split-pdf-ui');
                        } finally {
                            showLoader('split-pdf-ui', false);
                            disableButton('splitButton', false);
                        }
                    });
                }
            },
            'protect-pdf': {
                name: 'Protect PDF',
                icon: 'fa-lock',
                description: 'Add password protection to your PDF file. Set user password to restrict opening, and owner password to restrict permissions.',
                initUI: () => `
                    <div class="tool-section" id="protect-pdf-ui">
                        <h2><i class="fas fa-lock"></i> Protect PDF</h2>
                        <p class="description">${tools['protect-pdf'].description}</p>
                        
                        <div class="dropzone" id="protect-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="protectFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="protectFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="userPassword">User Password (to open):</label>
                            <input type="password" id="userPassword" placeholder="Optional">
                        </div>
                        
                        <div class="form-group">
                            <label for="ownerPassword">Owner Password (to restrict permissions):</label>
                            <input type="password" id="ownerPassword" placeholder="Required if user password is set">
                        </div>
                        
                        <div class="advanced-options">
                            <button type="button" class="toggle-advanced" id="togglePermissions">
                                <i class="fas fa-chevron-down"></i> Advanced Permissions
                            </button>
                            
                            <div id="permissionsOptions" style="display: none;">
                                <div class="form-group">
                                    <label>Allowed Actions:</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="allowPrinting" checked> Printing
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="allowModification" checked> Modification
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="allowCopy" checked> Copying
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="allowAnnotations" checked> Annotations
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="protectButton" class="action-button">
                            <i class="fas fa-shield-alt"></i> Protect PDF
                        </button>
                        
                        <div class="loader" id="protect-pdf-ui-loader"></div>
                        <div id="protect-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('protectFile');
                    
                    // Handle drag and drop
                    createDropzone('protect-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'protect-pdf-ui');
                        }
                    });
                    
                    // Toggle advanced options
                    document.getElementById('togglePermissions').addEventListener('click', function() {
                        const options = document.getElementById('permissionsOptions');
                        const isHidden = options.style.display === 'none';
                        options.style.display = isHidden ? 'block' : 'none';
                        this.classList.toggle('collapsed', !isHidden);
                    });
                    
                    // Protect button
                    document.getElementById('protectButton').addEventListener('click', async () => {
                        const userPassword = document.getElementById('userPassword').value;
                        const ownerPassword = document.getElementById('ownerPassword').value;

                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'protect-pdf-ui');
                            return;
                        }
                        if (userPassword && !ownerPassword) {
                            showStatus('Owner password is required if user password is set.', 'error', 'protect-pdf-ui');
                            return;
                        }
                        if (!userPassword && !ownerPassword) {
                            showStatus('Please set at least one password.', 'error', 'protect-pdf-ui');
                            return;
                        }

                        showLoader('protect-pdf-ui', true);
                        disableButton('protectButton', true);
                        showStatus('Protecting PDF...', 'info', 'protect-pdf-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdfDoc = await PDFDocument.load(arrayBuffer);
                            
                            const options = {};
                            if (userPassword) options.userPassword = userPassword;
                            if (ownerPassword) options.ownerPassword = ownerPassword;
                            
                            // Set permissions based on checkboxes
                            options.permissions = {
                                printing: document.getElementById('allowPrinting').checked ? 'allow' : 'deny',
                                modifying: document.getElementById('allowModification').checked ? 'allow' : 'deny',
                                copying: document.getElementById('allowCopy').checked ? 'allow' : 'deny',
                                annotating: document.getElementById('allowAnnotations').checked ? 'allow' : 'deny',
                            };

                            const protectedPdfBytes = await pdfDoc.save(options);
                            download(protectedPdfBytes, "protected.pdf", "application/pdf");
                            showStatus('PDF protected successfully! Download started.', 'success', 'protect-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error protecting PDF: ${e.message}`, 'error', 'protect-pdf-ui');
                        } finally {
                            showLoader('protect-pdf-ui', false);
                            disableButton('protectButton', false);
                        }
                    });
                }
            },
            'add-page-numbers': {
                name: 'Add Page Numbers',
                icon: 'fa-list-ol',
                description: 'Insert page numbers into your PDF document. Customize position, starting number, font size and style.',
                initUI: () => `
                    <div class="tool-section" id="add-page-numbers-ui">
                        <h2><i class="fas fa-list-ol"></i> Add Page Numbers</h2>
                        <p class="description">${tools['add-page-numbers'].description}</p>
                        
                        <div class="dropzone" id="pageNum-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="pageNumFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="pageNumFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="input-group">
                            <div class="form-group">
                                <label for="pageNumPosition">Position:</label>
                                <select id="pageNumPosition">
                                    <option value="bottom-center">Bottom Center</option>
                                    <option value="bottom-right">Bottom Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="top-center">Top Center</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="top-left">Top Left</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="pageNumFont">Font:</label>
                                <select id="pageNumFont">
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times-Roman">Times New Roman</option>
                                    <option value="Courier">Courier</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <div class="form-group">
                                <label for="pageNumStart">Start numbering from:</label>
                                <input type="number" id="pageNumStart" value="1" min="1">
                            </div>
                            
                            <div class="form-group">
                                <label for="pageNumFontSize">Font Size:</label>
                                <input type="number" id="pageNumFontSize" value="12" min="6" max="72">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="pageNumColor">Color:</label>
                            <input type="color" id="pageNumColor" value="#000000">
                        </div>
                        
                        <div class="form-group">
                            <label for="pageNumFormat">Number Format:</label>
                            <select id="pageNumFormat">
                                <option value="1">1, 2, 3...</option>
                                <option value="i">i, ii, iii...</option>
                                <option value="I">I, II, III...</option>
                                <option value="a">a, b, c...</option>
                                <option value="A">A, B, C...</option>
                                <option value="custom">Custom Format</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="customFormatGroup" style="display: none;">
                            <label for="pageNumCustomFormat">Custom Format (use {n} for page number):</label>
                            <input type="text" id="pageNumCustomFormat" placeholder="e.g., Page {n} of {total}">
                        </div>
                        
                        <button id="addPageNumButton" class="action-button">
                            <i class="fas fa-plus-circle"></i> Add Page Numbers
                        </button>
                        
                        <div class="loader" id="add-page-numbers-ui-loader"></div>
                        <div id="add-page-numbers-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('pageNumFile');
                    const formatSelect = document.getElementById('pageNumFormat');
                    const customFormatGroup = document.getElementById('customFormatGroup');
                    
                    // Handle drag and drop
                    createDropzone('pageNum-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'add-page-numbers-ui');
                        }
                    });
                    
                    // Show/hide custom format field
                    formatSelect.addEventListener('change', () => {
                        customFormatGroup.style.display = formatSelect.value === 'custom' ? 'block' : 'none';
                    });
                    
                    // Add page numbers button
                    document.getElementById('addPageNumButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'add-page-numbers-ui');
                            return;
                        }
                        
                        const position = document.getElementById('pageNumPosition').value;
                        const startPage = parseInt(document.getElementById('pageNumStart').value, 10);
                        const fontSize = parseInt(document.getElementById('pageNumFontSize').value, 10);
                        const fontType = document.getElementById('pageNumFont').value;
                        const colorHex = document.getElementById('pageNumColor').value;
                        const format = document.getElementById('pageNumFormat').value;
                        const customFormat = document.getElementById('pageNumCustomFormat').value;
                        
                        // Convert hex color to RGB
                        const r = parseInt(colorHex.substr(1, 2), 16) / 255;
                        const g = parseInt(colorHex.substr(3, 2), 16) / 255;
                        const b = parseInt(colorHex.substr(5, 2), 16) / 255;
                        
                        showLoader('add-page-numbers-ui', true);
                        disableButton('addPageNumButton', true);
                        showStatus('Adding page numbers...', 'info', 'add-page-numbers-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdfDoc = await PDFDocument.load(arrayBuffer);
                            const pages = pdfDoc.getPages();
                            const totalPages = pages.length;
                            const font = await pdfDoc.embedFont(StandardFonts[fontType]);

                            for (let i = 0; i < pages.length; i++) {
                                if ((i + 1) < startPage) continue; // Skip pages before startPage

                                const page = pages[i];
                                const { width, height } = page.getSize();
                                
                                // Determine page number text based on format
                                let pageNumText;
                                const pageNum = i + 1;
                                
                                if (format === 'custom') {
                                    pageNumText = customFormat
                                        .replace(/{n}/g, pageNum)
                                        .replace(/{total}/g, totalPages);
                                } else {
                                    switch(format) {
                                        case 'i': pageNumText = toRoman(pageNum, true); break;
                                        case 'I': pageNumText = toRoman(pageNum, false); break;
                                        case 'a': pageNumText = toAlpha(pageNum, true); break;
                                        case 'A': pageNumText = toAlpha(pageNum, false); break;
                                        default: pageNumText = pageNum.toString();
                                    }
                                }
                                
                                const textWidth = font.widthOfTextAtSize(pageNumText, fontSize);
                                
                                let x, y;
                                const margin = 30;

                                switch(position) {
                                    case 'bottom-center': x = width / 2 - textWidth / 2; y = margin; break;
                                    case 'bottom-right': x = width - textWidth - margin; y = margin; break;
                                    case 'bottom-left': x = margin; y = margin; break;
                                    case 'top-center': x = width / 2 - textWidth / 2; y = height - fontSize - margin; break;
                                    case 'top-right': x = width - textWidth - margin; y = height - fontSize - margin; break;
                                    case 'top-left': x = margin; y = height - fontSize - margin; break;
                                    default: x = width / 2 - textWidth / 2; y = margin; // Default bottom-center
                                }

                                page.drawText(pageNumText, { 
                                    x, 
                                    y, 
                                    size: fontSize, 
                                    font, 
                                    color: rgb(r, g, b) 
                                });
                            }

                            const numberedPdfBytes = await pdfDoc.save();
                            download(numberedPdfBytes, "numbered.pdf", "application/pdf");
                            showStatus('Page numbers added successfully! Download started.', 'success', 'add-page-numbers-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error adding page numbers: ${e.message}`, 'error', 'add-page-numbers-ui');
                        } finally {
                            showLoader('add-page-numbers-ui', false);
                            disableButton('addPageNumButton', false);
                        }
                    });
                    
                    // Helper functions for number formats
                    function toRoman(num, lowercase) {
                        const romanNumerals = [
                            ['M', 1000], ['CM', 900], ['D', 500], ['CD', 400],
                            ['C', 100], ['XC', 90], ['L', 50], ['XL', 40],
                            ['X', 10], ['IX', 9], ['V', 5], ['IV', 4], ['I', 1]
                        ];
                        
                        let result = '';
                        for (const [numeral, value] of romanNumerals) {
                            while (num >= value) {
                                result += numeral;
                                num -= value;
                            }
                        }
                        return lowercase ? result.toLowerCase() : result;
                    }
                    
                    function toAlpha(num, lowercase) {
                        let result = '';
                        while (num > 0) {
                            const remainder = (num - 1) % 26;
                            result = String.fromCharCode(65 + remainder) + result;
                            num = Math.floor((num - 1) / 26);
                        }
                        return lowercase ? result.toLowerCase() : result;
                    }
                }
            },
            'image-to-pdf': {
                name: 'Image to PDF',
                icon: 'fa-file-image',
                description: 'Convert one or more JPG or PNG images into a single PDF document. Drag and drop to reorder images before conversion.',
                initUI: () => `
                    <div class="tool-section" id="image-to-pdf-ui">
                        <h2><i class="fas fa-file-image"></i> Image to PDF</h2>
                        <p class="description">${tools['image-to-pdf'].description}</p>
                        
                        <div class="dropzone" id="image-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop image files here</p>
                            <p>or</p>
                            <label for="imageFiles" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select Images
                            </label>
                            <input type="file" id="imageFiles" multiple accept="image/jpeg,image/png" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label>Image Options:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="imageLayout" value="original" checked> Original Size
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="imageLayout" value="a4"> Fit to A4
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="imageLayout" value="letter"> Fit to Letter
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Page Orientation:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="pageOrientation" value="auto" checked> Auto
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="pageOrientation" value="portrait"> Portrait
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="pageOrientation" value="landscape"> Landscape
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="imageMargin">Margin (mm):</label>
                            <input type="number" id="imageMargin" value="10" min="0" max="50">
                        </div>
                        
                        <div id="imagePreviewContainer" class="image-preview-container"></div>
                        
                        <div class="button-group">
                            <button id="imageToPdfButton" class="action-button">
                                <i class="fas fa-file-pdf"></i> Convert to PDF
                            </button>
                            <button id="clearImagesButton" class="action-button secondary">
                                <i class="fas fa-trash-alt"></i> Clear All
                            </button>
                        </div>
                        
                        <div class="loader" id="image-to-pdf-ui-loader"></div>
                        <div id="image-to-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const imageInput = document.getElementById('imageFiles');
                    const previewContainer = document.getElementById('imagePreviewContainer');
                    let images = [];
                    
                    // Handle drag and drop
                    createDropzone('image-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            images = Array.from(droppedFiles).filter(file => 
                                file.type === 'image/jpeg' || file.type === 'image/png');
                            updateImagePreviews();
                        }
                    });
                    
                    // Handle file selection via button
                    imageInput.addEventListener('change', () => {
                        if (imageInput.files.length > 0) {
                            images = Array.from(imageInput.files);
                            updateImagePreviews();
                        }
                    });
                    
                    // Update the image previews
                    function updateImagePreviews() {
                        previewContainer.innerHTML = '';
                        
                        if (images.length === 0) {
                            previewContainer.innerHTML = '<p>No images selected</p>';
                            return;
                        }
                        
                        const list = document.createElement('div');
                        list.className = 'page-thumbnails';
                        
                        images.forEach((image, index) => {
                            const item = document.createElement('div');
                            item.className = 'page-thumbnail';
                            item.draggable = true;
                            item.dataset.index = index;
                            
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.alt = `Image ${index + 1}`;
                                img.title = image.name;
                                
                                const fileName = document.createElement('div');
                                fileName.className = 'file-name';
                                fileName.textContent = image.name.length > 20 ? 
                                    image.name.substring(0, 17) + '...' : image.name;
                                fileName.style.fontSize = '0.7rem';
                                fileName.style.marginTop = '0.3rem';
                                fileName.style.textAlign = 'center';
                                
                                item.appendChild(img);
                                item.appendChild(fileName);
                                
                                item.addEventListener('dragstart', (e) => {
                                    e.dataTransfer.setData('text/plain', index);
                                });
                                
                                item.addEventListener('dragover', (e) => {
                                    e.preventDefault();
                                });
                                
                                item.addEventListener('drop', (e) => {
                                    e.preventDefault();
                                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                                    const toIndex = index;
                                    if (fromIndex !== toIndex) {
                                        const imageToMove = images[fromIndex];
                                        images.splice(fromIndex, 1);
                                        images.splice(toIndex, 0, imageToMove);
                                        updateImagePreviews();
                                    }
                                });
                            };
                            
                            reader.readAsDataURL(image);
                            list.appendChild(item);
                        });
                        
                        previewContainer.appendChild(list);
                    }
                    
                    // Clear button
                    document.getElementById('clearImagesButton').addEventListener('click', () => {
                        images = [];
                        imageInput.value = '';
                        updateImagePreviews();
                        showStatus('Image list cleared.', 'info', 'image-to-pdf-ui');
                    });
                    
                    // Convert button
                    document.getElementById('imageToPdfButton').addEventListener('click', async () => {
                        if (images.length === 0) {
                            showStatus('Please select at least one image file.', 'error', 'image-to-pdf-ui');
                            return;
                        }
                        
                        const layout = document.querySelector('input[name="imageLayout"]:checked').value;
                        const orientation = document.querySelector('input[name="pageOrientation"]:checked').value;
                        const margin = parseInt(document.getElementById('imageMargin').value, 10);
                        
                        showLoader('image-to-pdf-ui', true);
                        disableButton('imageToPdfButton', true);
                        showStatus('Converting images to PDF...', 'info', 'image-to-pdf-ui');
                        
                        try {
                            const pdfDoc = await PDFDocument.create();
                            
                            for (const file of images) {
                                try {
                                    const arrayBuffer = await file.arrayBuffer();
                                    let image;
                                    
                                    if (file.type === 'image/jpeg') {
                                        image = await pdfDoc.embedJpg(arrayBuffer);
                                    } else if (file.type === 'image/png') {
                                        image = await pdfDoc.embedPng(arrayBuffer);
                                    } else {
                                        continue; // Skip unsupported types
                                    }
                                    
                                    if (layout === 'original') {
                                        // Add page with original image dimensions
                                        const page = pdfDoc.addPage([image.width, image.height]);
                                        page.drawImage(image, {
                                            x: 0,
                                            y: 0,
                                            width: image.width,
                                            height: image.height,
                                        });
                                    } else {
                                        // Standard page sizes (A4 or Letter)
                                        let pageWidth, pageHeight;
                                        if (layout === 'a4') {
                                            pageWidth = 595.28; // A4 width in points (210mm)
                                            pageHeight = 841.89; // A4 height in points (297mm)
                                        } else { // letter
                                            pageWidth = 612; // Letter width in points (8.5in)
                                            pageHeight = 792; // Letter height in points (11in)
                                        }
                                        
                                        // Handle orientation
                                        let isLandscape = false;
                                        if (orientation === 'auto') {
                                            isLandscape = image.width > image.height;
                                        } else if (orientation === 'landscape') {
                                            isLandscape = true;
                                        }
                                        
                                        if (isLandscape) {
                                            [pageWidth, pageHeight] = [pageHeight, pageWidth];
                                        }
                                        
                                        // Calculate margin in points (1mm = 2.83465 points)
                                        const marginPoints = margin * 2.83465;
                                        
                                        // Calculate available space after margins
                                        const availableWidth = pageWidth - (2 * marginPoints);
                                        const availableHeight = pageHeight - (2 * marginPoints);
                                        
                                        // Calculate scaling to fit image within available space
                                        const widthRatio = availableWidth / image.width;
                                        const heightRatio = availableHeight / image.height;
                                        const scale = Math.min(widthRatio, heightRatio);
                                        
                                        const scaledWidth = image.width * scale;
                                        const scaledHeight = image.height * scale;
                                        
                                        // Center the image on the page
                                        const x = (pageWidth - scaledWidth) / 2;
                                        const y = (pageHeight - scaledHeight) / 2;
                                        
                                        const page = pdfDoc.addPage([pageWidth, pageHeight]);
                                        page.drawImage(image, {
                                            x,
                                            y,
                                            width: scaledWidth,
                                            height: scaledHeight,
                                        });
                                    }
                                } catch (e) {
                                    console.error(`Error processing image ${file.name}:`, e);
                                    showStatus(`Error processing ${file.name}: ${e.message}`, 'error', 'image-to-pdf-ui');
                                    continue;
                                }
                            }
                            
                            const pdfBytes = await pdfDoc.save();
                            download(pdfBytes, "images.pdf", "application/pdf");
                            showStatus('Images converted to PDF successfully! Download started.', 'success', 'image-to-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error converting images: ${e.message}`, 'error', 'image-to-pdf-ui');
                        } finally {
                            showLoader('image-to-pdf-ui', false);
                            disableButton('imageToPdfButton', false);
                        }
                    });
                }
            },
            'pdf-to-image': {
                name: 'PDF to Image',
                icon: 'fa-image',
                description: 'Convert each page of a PDF to an image (JPG or PNG). This can be slow for large PDFs. Preview the first few pages before converting all.',
                initUI: () => `
                    <div class="tool-section" id="pdf-to-image-ui">
                        <h2><i class="fas fa-image"></i> PDF to Image</h2>
                        <p class="description">${tools['pdf-to-image'].description}</p>
                        
                        <div class="dropzone" id="pdfToImage-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="pdfToImageFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="pdfToImageFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="input-group">
                            <div class="form-group">
                                <label for="imageFormat">Output Format:</label>
                                <select id="imageFormat">
                                    <option value="image/jpeg">JPG</option>
                                    <option value="image/png">PNG</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="imageQuality">Quality (for JPG):</label>
                                <input type="range" id="imageQuality" min="0.1" max="1.0" step="0.05" value="0.92">
                                <div class="range-labels">
                                    <span>Low</span>
                                    <span>Medium</span>
                                    <span>High</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="imageScale">Resolution Scale:</label>
                            <input type="range" id="imageScale" min="1" max="3" step="0.5" value="2">
                            <div class="range-labels">
                                <span>Low (1x)</span>
                                <span>Medium (1.5x)</span>
                                <span>High (2x)</span>
                                <span>Very High (3x)</span>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button id="previewPagesButton" class="action-button">
                                <i class="fas fa-eye"></i> Preview First 5 Pages
                            </button>
                            <button id="pdfToImageButton" class="action-button">
                                <i class="fas fa-download"></i> Convert All Pages
                            </button>
                        </div>
                        
                        <div id="pdfToImagePreviewContainer" class="image-preview-container"></div>
                        <div class="progress-bar" id="pdf-to-image-progress" style="display: none;">
                            <div class="progress-bar-fill"></div>
                        </div>
                        
                        <div class="loader" id="pdf-to-image-ui-loader"></div>
                        <div id="pdf-to-image-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('pdfToImageFile');
                    const previewContainer = document.getElementById('pdfToImagePreviewContainer');
                    
                    // Handle drag and drop
                    createDropzone('pdfToImage-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'pdf-to-image-ui');
                        }
                    });
                    
                    // Preview button
                    document.getElementById('previewPagesButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'pdf-to-image-ui');
                            return;
                        }
                        
                        const format = document.getElementById('imageFormat').value;
                        const quality = parseFloat(document.getElementById('imageQuality').value);
                        const scale = parseFloat(document.getElementById('imageScale').value);
                        
                        showLoader('pdf-to-image-ui', true);
                        disableButton('previewPagesButton', true);
                        disableButton('pdfToImageButton', true);
                        showStatus('Generating previews for first 5 pages...', 'info', 'pdf-to-image-ui');
                        previewContainer.innerHTML = '';
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            const numPages = pdf.numPages;
                            const previewPageCount = Math.min(numPages, 5);
                            
                            for (let i = 1; i <= previewPageCount; i++) {
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                
                                const imageDataUrl = canvas.toDataURL(format, format === 'image/jpeg' ? quality : undefined);
                                
                                const img = document.createElement('img');
                                img.src = imageDataUrl;
                                img.alt = `Page ${i}`;
                                img.title = `Page ${i}`;
                                
                                const pageDiv = document.createElement('div');
                                pageDiv.style.textAlign = 'center';
                                pageDiv.appendChild(img);
                                pageDiv.innerHTML += `<div style="font-size: 0.8rem; margin-top: 0.3rem;">Page ${i}</div>`;
                                
                                previewContainer.appendChild(pageDiv);
                                canvas.remove();
                            }
                            
                            if (numPages > 5) {
                                previewContainer.innerHTML += `<div style="text-align: center; font-style: italic;">+ ${numPages - 5} more pages...</div>`;
                            }
                            
                            showStatus(`Preview generated for first ${previewPageCount} pages.`, 'success', 'pdf-to-image-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error generating preview: ${e.message}`, 'error', 'pdf-to-image-ui');
                        } finally {
                            showLoader('pdf-to-image-ui', false);
                            disableButton('previewPagesButton', false);
                            disableButton('pdfToImageButton', false);
                        }
                    });
                    
                    // Convert all button
                    document.getElementById('pdfToImageButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'pdf-to-image-ui');
                            return;
                        }
                        
                        const format = document.getElementById('imageFormat').value;
                        const quality = parseFloat(document.getElementById('imageQuality').value);
                        const scale = parseFloat(document.getElementById('imageScale').value);
                        
                        showLoader('pdf-to-image-ui', true);
                        disableButton('previewPagesButton', true);
                        disableButton('pdfToImageButton', true);
                        showStatus('Converting PDF to images...', 'info', 'pdf-to-image-ui');
                        previewContainer.innerHTML = '';
                        document.getElementById('pdf-to-image-progress').style.display = 'block';
                        updateProgressBar('pdf-to-image-progress', 0);
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            const numPages = pdf.numPages;
                            const fileBaseName = fileInput.files[0].name.replace(/\.pdf$/i, '');
                            
                            for (let i = 1; i <= numPages; i++) {
                                showStatus(`Processing page ${i} of ${numPages}...`, 'info', 'pdf-to-image-ui');
                                updateProgressBar('pdf-to-image-progress', (i / numPages) * 100);
                                
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                
                                const imageDataUrl = canvas.toDataURL(format, format === 'image/jpeg' ? quality : undefined);
                                download(imageDataUrl, `${fileBaseName}_page_${i}.${format.split('/')[1]}`, format);
                                
                                // Add a small preview for the first few pages
                                if (i <= 5) {
                                    const img = document.createElement('img');
                                    img.src = imageDataUrl;
                                    img.alt = `Page ${i}`;
                                    img.title = `Page ${i}`;
                                    previewContainer.appendChild(img);
                                }
                                
                                canvas.remove();
                            }
                            
                            showStatus(`PDF converted to ${numPages} image(s) successfully! Downloads started.`, 'success', 'pdf-to-image-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error converting PDF to images: ${e.message}`, 'error', 'pdf-to-image-ui');
                        } finally {
                            showLoader('pdf-to-image-ui', false);
                            disableButton('previewPagesButton', false);
                            disableButton('pdfToImageButton', false);
                            document.getElementById('pdf-to-image-progress').style.display = 'none';
                        }
                    });
                }
            },
            'ocr-pdf': {
                name: 'OCR PDF',
                icon: 'fa-font',
                description: 'Extract text from a PDF (especially scanned PDFs) using Optical Character Recognition. This can be slow and resource-intensive. English language only for this demo.',
                initUI: () => `
                    <div class="tool-section" id="ocr-pdf-ui">
                        <h2><i class="fas fa-font"></i> OCR PDF</h2>
                        <p class="description">${tools['ocr-pdf'].description}</p>
                        
                        <div class="dropzone" id="ocr-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="ocrFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="ocrFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="ocrLanguage">Language:</label>
                            <select id="ocrLanguage">
                                <option value="eng">English</option>
                                <option value="fra">French</option>
                                <option value="deu">German</option>
                                <option value="spa">Spanish</option>
                                <option value="ita">Italian</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="ocrDpi">DPI (Resolution):</label>
                            <select id="ocrDpi">
                                <option value="150">150 DPI (Faster)</option>
                                <option value="300" selected>300 DPI (Balanced)</option>
                                <option value="600">600 DPI (Slower, more accurate)</option>
                            </select>
                        </div>
                        
                        <button id="ocrButton" class="action-button">
                            <i class="fas fa-search"></i> Extract Text
                        </button>
                        
                        <div class="progress-bar" id="ocr-pdf-progress" style="display: none;">
                            <div class="progress-bar-fill"></div>
                        </div>
                        
                        <div class="loader" id="ocr-pdf-ui-loader"></div>
                        <div id="ocr-pdf-ui-status" class="status-message" style="display:none;"></div>
                        
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="ocrResultText">Extracted Text:</label>
                            <textarea id="ocrResultText" readonly placeholder="Extracted text will appear here..."></textarea>
                        </div>
                        
                        <div class="button-group">
                            <button id="copyTextButton" class="action-button secondary" disabled>
                                <i class="fas fa-copy"></i> Copy Text
                            </button>
                            <button id="downloadTextButton" class="action-button secondary" disabled>
                                <i class="fas fa-download"></i> Download Text
                            </button>
                        </div>
                    </div>
                `,
                attachListeners: async () => {
                    const fileInput = document.getElementById('ocrFile');
                    const resultTextArea = document.getElementById('ocrResultText');
                    const copyButton = document.getElementById('copyTextButton');
                    const downloadButton = document.getElementById('downloadTextButton');
                    
                    // Handle drag and drop
                    createDropzone('ocr-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'ocr-pdf-ui');
                        }
                    });
                    
                    // Copy text button
                    copyButton.addEventListener('click', () => {
                        resultTextArea.select();
                        document.execCommand('copy');
                        showStatus('Text copied to clipboard!', 'success', 'ocr-pdf-ui');
                    });
                    
                    // Download text button
                    downloadButton.addEventListener('click', () => {
                        const blob = new Blob([resultTextArea.value], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        download(url, "extracted_text.txt", "text/plain");
                        URL.revokeObjectURL(url);
                        showStatus('Text downloaded!', 'success', 'ocr-pdf-ui');
                    });
                    
                    // OCR button
                    document.getElementById('ocrButton').addEventListener('click', async () => {
                        resultTextArea.value = '';
                        copyButton.disabled = true;
                        downloadButton.disabled = true;

                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'ocr-pdf-ui');
                            return;
                        }
                        
                        const language = document.getElementById('ocrLanguage').value;
                        const dpi = parseInt(document.getElementById('ocrDpi').value, 10);
                        
                        showLoader('ocr-pdf-ui', true);
                        disableButton('ocrButton', true);
                        showStatus('Starting OCR process...', 'info', 'ocr-pdf-ui');
                        currentTool = 'ocr-pdf-ui'; // For Tesseract status updates
                        document.getElementById('ocr-pdf-progress').style.display = 'block';
                        updateProgressBar('ocr-pdf-progress', 0);

                        try {
                            const worker = await initializeTesseract(); // Ensure worker is ready
                            await worker.loadLanguage(language);
                            await worker.initialize(language);
                            
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            const numPages = pdf.numPages;
                            let fullText = '';

                            for (let i = 1; i <= numPages; i++) {
                                showStatus(`OCR: Processing page ${i} of ${numPages}...`, 'info', 'ocr-pdf-ui');
                                updateProgressBar('ocr-pdf-progress', (i / numPages) * 50);
                                
                                const page = await pdf.getPage(i);
                                
                                // Calculate scale based on DPI (72 DPI is 1:1 in PDF.js)
                                const scale = dpi / 72;
                                const viewport = page.getViewport({ scale });
                                
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;

                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                
                                updateProgressBar('ocr-pdf-progress', 50 + (i / numPages) * 50);
                                const { data: { text } } = await worker.recognize(canvas);
                                
                                fullText += `--- Page ${i} ---\n\n${text}\n\n`;
                                resultTextArea.value = fullText; // Update progressively
                                canvas.remove();
                            }
                            
                            showStatus(`OCR completed for ${numPages} page(s).`, 'success', 'ocr-pdf-ui');
                            copyButton.disabled = false;
                            downloadButton.disabled = false;
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error during OCR: ${e.message}`, 'error', 'ocr-pdf-ui');
                            resultTextArea.value = `Error: ${e.message}`;
                        } finally {
                            showLoader('ocr-pdf-ui', false);
                            disableButton('ocrButton', false);
                            document.getElementById('ocr-pdf-progress').style.display = 'none';
                        }
                    });
                }
            },
            'compress-pdf': {
                name: 'Compress PDF',
                icon: 'fa-compress-alt',
                description: 'Reduce PDF file size by optimizing images and removing unnecessary data. Note that significant compression may reduce quality.',
                initUI: () => `
                    <div class="tool-section" id="compress-pdf-ui">
                        <h2><i class="fas fa-compress-alt"></i> Compress PDF</h2>
                        <p class="description">${tools['compress-pdf'].description}</p>
                        
                        <div class="dropzone" id="compress-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="compressFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="compressFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="compressionLevel">Compression Level:</label>
                            <select id="compressionLevel">
                                <option value="low">Low (Better quality)</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="high">High (Smaller file)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="imageQuality">Image Quality (if present):</label>
                            <input type="range" id="imageQualityCompress" min="0.1" max="1.0" step="0.1" value="0.8">
                            <div class="range-labels">
                                <span>Low</span>
                                <span>Medium</span>
                                <span>High</span>
                            </div>
                        </div>
                        
                        <button id="compressButton" class="action-button">
                            <i class="fas fa-file-archive"></i> Compress PDF
                        </button>
                        
                        <div class="loader" id="compress-pdf-ui-loader"></div>
                        <div id="compress-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('compressFile');
                    
                    // Handle drag and drop
                    createDropzone('compress-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'compress-pdf-ui');
                        }
                    });
                    
                    // Compress button
                    document.getElementById('compressButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'compress-pdf-ui');
                            return;
                        }
                        
                        const level = document.getElementById('compressionLevel').value;
                        const imageQuality = parseFloat(document.getElementById('imageQualityCompress').value);
                        
                        showLoader('compress-pdf-ui', true);
                        disableButton('compressButton', true);
                        showStatus('Compressing PDF...', 'info', 'compress-pdf-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdfDoc = await PDFDocument.load(arrayBuffer);
                            
                            // Set save options based on compression level
                            const options = {};
                            
                            if (level === 'low') {
                                options.useObjectStreams = false;
                                options.throwOnInvalidObject = true;
                            } else if (level === 'medium') {
                                options.useObjectStreams = true;
                                options.throwOnInvalidObject = false;
                            } else { // high
                                options.useObjectStreams = true;
                                options.throwOnInvalidObject = false;
                                options.forcePDFA1 = true;
                            }
                            
                            // If the PDF contains images, we can try to re-embed them with lower quality
                            // Note: This is a simplified approach - real compression would need more sophisticated processing
                            const pages = pdfDoc.getPages();
                            for (const page of pages) {
                                const images = page.node.Resources().getImageIndices();
                                for (const imageRef of images) {
                                    try {
                                        const image = await pdfDoc.embedPng(imageRef);
                                        // In a real implementation, we would re-embed with lower quality here
                                    } catch (e) {
                                        // Skip if not an image we can process
                                    }
                                }
                            }
                            
                            const compressedPdfBytes = await pdfDoc.save(options);
                            download(compressedPdfBytes, "compressed.pdf", "application/pdf");
                            
                            // Calculate compression ratio
                            const originalSize = arrayBuffer.byteLength;
                            const compressedSize = compressedPdfBytes.byteLength;
                            const ratio = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
                            
                            showStatus(`PDF compressed successfully! Reduced by ${ratio}%. Download started.`, 'success', 'compress-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error compressing PDF: ${e.message}`, 'error', 'compress-pdf-ui');
                        } finally {
                            showLoader('compress-pdf-ui', false);
                            disableButton('compressButton', false);
                        }
                    });
                }
            },
            'organize-pdf': {
                name: 'Organize PDF',
                icon: 'fa-layer-group',
                description: 'Reorder, delete, or rotate pages in a PDF. Drag and drop thumbnails to reorder pages before saving.',
                initUI: () => `
                    <div class="tool-section" id="organize-pdf-ui">
                        <h2><i class="fas fa-layer-group"></i> Organize PDF</h2>
                        <p class="description">${tools['organize-pdf'].description}</p>
                        
                        <div class="dropzone" id="organize-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="organizeFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="organizeFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div id="pageThumbnailsContainer" style="margin: 1.5rem 0; display: none;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Pages Preview</h3>
                            <div id="pageThumbnails" class="page-thumbnails"></div>
                        </div>
                        
                        <div class="button-group" id="organizeButtons" style="display: none;">
                            <button id="saveOrganizedButton" class="action-button">
                                <i class="fas fa-save"></i> Save PDF
                            </button>
                            <button id="resetOrganizeButton" class="action-button secondary">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                        
                        <div class="loader" id="organize-pdf-ui-loader"></div>
                        <div id="organize-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('organizeFile');
                    const thumbnailsContainer = document.getElementById('pageThumbnailsContainer');
                    const thumbnails = document.getElementById('pageThumbnails');
                    const organizeButtons = document.getElementById('organizeButtons');
                    let pdfDoc = null;
                    let pageOrder = [];
                    
                    // Handle drag and drop
                    createDropzone('organize-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            loadPdfForOrganization();
                        }
                    });
                    
                    // Handle file selection
                    fileInput.addEventListener('change', () => {
                        if (fileInput.files.length > 0) {
                            loadPdfForOrganization();
                        }
                    });
                    
                    // Load PDF and generate thumbnails
                    async function loadPdfForOrganization() {
                        showLoader('organize-pdf-ui', true);
                        disableButton('saveOrganizedButton', true);
                        disableButton('resetOrganizeButton', true);
                        showStatus('Loading PDF for organization...', 'info', 'organize-pdf-ui');
                        thumbnails.innerHTML = '';
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            pdfDoc = await PDFDocument.load(arrayBuffer);
                            const numPages = pdfDoc.getPageCount();
                            pageOrder = Array.from({ length: numPages }, (_, i) => i); // [0, 1, 2, ...]
                            
                            // Generate thumbnails
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            const previewPageCount = Math.min(numPages, 20); // Limit to first 20 pages for performance
                            
                            for (let i = 1; i <= previewPageCount; i++) {
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale: 0.5 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                
                                const thumbnail = document.createElement('div');
                                thumbnail.className = 'page-thumbnail';
                                thumbnail.dataset.index = i - 1;
                                
                                const img = document.createElement('img');
                                img.src = canvas.toDataURL('image/jpeg', 0.7);
                                img.alt = `Page ${i}`;
                                
                                const pageNum = document.createElement('div');
                                pageNum.className = 'page-number';
                                pageNum.textContent = i;
                                
                                const pageActions = document.createElement('div');
                                pageActions.className = 'page-actions';
                                
                                const rotateLeftBtn = document.createElement('button');
                                rotateLeftBtn.title = 'Rotate left';
                                rotateLeftBtn.innerHTML = '<i class="fas fa-undo"></i>';
                                rotateLeftBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    rotatePage(i - 1, -90);
                                });
                                
                                const rotateRightBtn = document.createElement('button');
                                rotateRightBtn.title = 'Rotate right';
                                rotateRightBtn.innerHTML = '<i class="fas fa-redo"></i>';
                                rotateRightBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    rotatePage(i - 1, 90);
                                });
                                
                                const deleteBtn = document.createElement('button');
                                deleteBtn.title = 'Delete page';
                                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                                deleteBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    deletePage(i - 1);
                                });
                                
                                pageActions.appendChild(rotateLeftBtn);
                                pageActions.appendChild(rotateRightBtn);
                                pageActions.appendChild(deleteBtn);
                                
                                thumbnail.appendChild(pageNum);
                                thumbnail.appendChild(img);
                                thumbnail.appendChild(pageActions);
                                thumbnails.appendChild(thumbnail);
                                
                                canvas.remove();
                            }
                            
                            if (numPages > 20) {
                                thumbnails.innerHTML += `<div style="text-align: center; font-style: italic;">+ ${numPages - 20} more pages...</div>`;
                            }
                            
                            // Initialize drag and drop sorting
                            if (sortableInstance) sortableInstance.destroy();
                            sortableInstance = new Sortable(thumbnails, {
                                animation: 150,
                                onEnd: function() {
                                    // Update page order based on new positions
                                    pageOrder = Array.from(thumbnails.children)
                                        .filter(el => el.dataset.index !== undefined)
                                        .map(el => parseInt(el.dataset.index));
                                }
                            });
                            
                            thumbnailsContainer.style.display = 'block';
                            organizeButtons.style.display = 'flex';
                            showStatus('PDF loaded. Drag to reorder pages or use action buttons.', 'success', 'organize-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error loading PDF: ${e.message}`, 'error', 'organize-pdf-ui');
                        } finally {
                            showLoader('organize-pdf-ui', false);
                            disableButton('saveOrganizedButton', false);
                            disableButton('resetOrganizeButton', false);
                        }
                    }
                    
                    // Rotate a page
                    async function rotatePage(pageIndex, angle) {
                        showStatus(`Rotating page ${pageIndex + 1}...`, 'info', 'organize-pdf-ui');
                        try {
                            const page = pdfDoc.getPage(pageIndex);
                            page.setRotation(degrees(page.node.Rotate() + angle));
                            showStatus(`Page ${pageIndex + 1} rotated. Don't forget to save!`, 'success', 'organize-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error rotating page: ${e.message}`, 'error', 'organize-pdf-ui');
                        }
                    }
                    
                    // Delete a page
                    async function deletePage(pageIndex) {
                        if (!confirm(`Are you sure you want to delete page ${pageIndex + 1}?`)) return;
                        
                        showStatus(`Deleting page ${pageIndex + 1}...`, 'info', 'organize-pdf-ui');
                        try {
                            // Remove from page order array
                            pageOrder = pageOrder.filter(idx => idx !== pageIndex);
                            
                            // Remove the thumbnail
                            const thumbnails = document.getElementById('pageThumbnails');
                            const thumbnail = thumbnails.querySelector(`[data-index="${pageIndex}"]`);
                            if (thumbnail) thumbnail.remove();
                            
                            showStatus(`Page ${pageIndex + 1} deleted. Don't forget to save!`, 'success', 'organize-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error deleting page: ${e.message}`, 'error', 'organize-pdf-ui');
                        }
                    }
                    
                    // Save organized PDF
                    document.getElementById('saveOrganizedButton').addEventListener('click', async () => {
                        if (!pdfDoc) {
                            showStatus('No PDF loaded to save.', 'error', 'organize-pdf-ui');
                            return;
                        }
                        
                        showLoader('organize-pdf-ui', true);
                        disableButton('saveOrganizedButton', true);
                        showStatus('Saving organized PDF...', 'info', 'organize-pdf-ui');
                        
                        try {
                            // Create a new PDF with the reordered pages
                            const newPdfDoc = await PDFDocument.create();
                            
                            // Copy pages in the new order (filtering out deleted pages)
                            const pagesToCopy = pageOrder.filter(idx => idx >= 0 && idx < pdfDoc.getPageCount());
                            const copiedPages = await newPdfDoc.copyPages(pdfDoc, pagesToCopy);
                            copiedPages.forEach(page => newPdfDoc.addPage(page));
                            
                            const newPdfBytes = await newPdfDoc.save();
                            download(newPdfBytes, "organized.pdf", "application/pdf");
                            showStatus('Organized PDF saved successfully! Download started.', 'success', 'organize-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error saving organized PDF: ${e.message}`, 'error', 'organize-pdf-ui');
                        } finally {
                            showLoader('organize-pdf-ui', false);
                            disableButton('saveOrganizedButton', false);
                        }
                    });
                    
                    // Reset organization
                    document.getElementById('resetOrganizeButton').addEventListener('click', () => {
                        if (confirm('Reset all changes and reload original PDF?')) {
                            loadPdfForOrganization();
                        }
                    });
                }
            },
            'pdf-to-word': {
                name: 'PDF to Word',
                icon: 'fa-file-word',
                description: 'Convert PDF to Word (.docx) format. This extracts text and basic formatting. For complex layouts, consider using our OCR tool first.',
                initUI: () => `
                    <div class="tool-section" id="pdf-to-word-ui">
                        <h2><i class="fas fa-file-word"></i> PDF to Word</h2>
                        <p class="description">${tools['pdf-to-word'].description}</p>
                        
                        <div class="dropzone" id="word-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="wordFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="wordFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="wordFormat">Output Format:</label>
                            <select id="wordFormat">
                                <option value="docx">DOCX (Word Document)</option>
                                <option value="rtf">RTF (Rich Text Format)</option>
                                <option value="txt">Plain Text</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="wordPreserveFormatting">Preserve Formatting:</label>
                            <select id="wordPreserveFormatting">
                                <option value="basic">Basic (Headings, Lists)</option>
                                <option value="full">Full (Fonts, Colors)</option>
                                <option value="none">None (Plain Text)</option>
                            </select>
                        </div>
                        
                        <button id="wordConvertButton" class="action-button">
                            <i class="fas fa-exchange-alt"></i> Convert to Word
                        </button>
                        
                        <div class="loader" id="pdf-to-word-ui-loader"></div>
                        <div id="pdf-to-word-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('wordFile');
                    
                    // Handle drag and drop
                    createDropzone('word-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'pdf-to-word-ui');
                        }
                    });
                    
                    // Convert button
                    document.getElementById('wordConvertButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'pdf-to-word-ui');
                            return;
                        }
                        
                        const format = document.getElementById('wordFormat').value;
                        const preserveFormatting = document.getElementById('wordPreserveFormatting').value;
                        
                        showLoader('pdf-to-word-ui', true);
                        disableButton('wordConvertButton', true);
                        showStatus('Converting PDF to Word format...', 'info', 'pdf-to-word-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            const numPages = pdf.numPages;
                            let fullText = '';
                            
                            for (let i = 1; i <= numPages; i++) {
                                showStatus(`Processing page ${i} of ${numPages}...`, 'info', 'pdf-to-word-ui');
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                
                                // Basic text extraction
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n\n';
                            }
                            
                            // In a real implementation, we would convert to DOCX/RTF properly
                            // For this demo, we'll just create a simple text file with .docx extension
                            const fileName = fileInput.files[0].name.replace(/\.pdf$/i, '');
                            let mimeType, extension;
                            
                            switch(format) {
                                case 'docx':
                                    mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                                    extension = 'docx';
                                    break;
                                case 'rtf':
                                    mimeType = 'application/rtf';
                                    extension = 'rtf';
                                    break;
                                default:
                                    mimeType = 'text/plain';
                                    extension = 'txt';
                            }
                            
                            // Create a simple document (in a real app, use a library like docx or mammoth)
                            let docContent;
                            if (format === 'rtf') {
                                docContent = '{\\rtf1\\ansi\\deff0\n{\\fonttbl{\\f0\\fnil\\fcharset0 Arial;}}\n\\f0\\fs24\n';
                                docContent += fullText.split('\n').map(line => line + '\\par').join('\n');
                                docContent += '\n}';
                            } else {
                                docContent = fullText;
                            }
                            
                            const blob = new Blob([docContent], { type: mimeType });
                            const url = URL.createObjectURL(blob);
                            download(url, `${fileName}.${extension}`, mimeType);
                            URL.revokeObjectURL(url);
                            
                            showStatus('Conversion complete! Download started.', 'success', 'pdf-to-word-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error converting PDF: ${e.message}`, 'error', 'pdf-to-word-ui');
                        } finally {
                            showLoader('pdf-to-word-ui', false);
                            disableButton('wordConvertButton', false);
                        }
                    });
                }
            },
            'word-to-pdf': {
                name: 'Word to PDF',
                icon: 'fa-file-pdf',
                description: 'Convert Word documents (.docx) to PDF format. This tool preserves text formatting and basic layout.',
                initUI: () => `
                    <div class="tool-section" id="word-to-pdf-ui">
                        <h2><i class="fas fa-file-pdf"></i> Word to PDF</h2>
                        <p class="description">${tools['word-to-pdf'].description}</p>
                        
                        <div class="dropzone" id="wordToPdf-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop Word files here</p>
                            <p>or</p>
                            <label for="wordToPdfFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select Files
                            </label>
                            <input type="file" id="wordToPdfFile" accept=".docx,.doc" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="pdfPageSize">Page Size:</label>
                            <select id="pdfPageSize">
                                <option value="A4">A4</option>
                                <option value="Letter">Letter</option>
                                <option value="Legal">Legal</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="pdfOrientation">Orientation:</label>
                            <select id="pdfOrientation">
                                <option value="portrait">Portrait</option>
                                <option value="landscape">Landscape</option>
                            </select>
                        </div>
                        
                        <button id="wordToPdfButton" class="action-button">
                            <i class="fas fa-exchange-alt"></i> Convert to PDF
                        </button>
                        
                        <div class="loader" id="word-to-pdf-ui-loader"></div>
                        <div id="word-to-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('wordToPdfFile');
                    
                    // Handle drag and drop
                    createDropzone('wordToPdf-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'word-to-pdf-ui');
                        }
                    });
                    
                    // Convert button
                    document.getElementById('wordToPdfButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a Word document.', 'error', 'word-to-pdf-ui');
                            return;
                        }
                        
                        showLoader('word-to-pdf-ui', true);
                        disableButton('wordToPdfButton', true);
                        showStatus('Converting Word to PDF...', 'info', 'word-to-pdf-ui');
                        
                        try {
                            // In a real implementation, we would use a library like docx or mammoth
                            // For this demo, we'll create a simple PDF with the text content
                            const file = fileInput.files[0];
                            const fileName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
                            
                            // Read the file as text (in reality, we'd parse the DOCX properly)
                            const text = await file.text();
                            
                            // Create a simple PDF with the text
                            const pdfDoc = await PDFDocument.create();
                            
                            // Set page size
                            let pageWidth, pageHeight;
                            const orientation = document.getElementById('pdfOrientation').value;
                            const pageSize = document.getElementById('pdfPageSize').value;
                            
                            switch(pageSize) {
                                case 'A4':
                                    pageWidth = 595.28;
                                    pageHeight = 841.89;
                                    break;
                                case 'Letter':
                                    pageWidth = 612;
                                    pageHeight = 792;
                                    break;
                                case 'Legal':
                                    pageWidth = 612;
                                    pageHeight = 1008;
                                    break;
                                default:
                                    pageWidth = 595.28;
                                    pageHeight = 841.89;
                            }
                            
                            if (orientation === 'landscape') {
                                [pageWidth, pageHeight] = [pageHeight, pageWidth];
                            }
                            
                            const page = pdfDoc.addPage([pageWidth, pageHeight]);
                            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                            
                            // Add text to the PDF (simplified - real conversion would preserve formatting)
                            page.drawText(text, {
                                x: 50,
                                y: pageHeight - 50,
                                size: 12,
                                font: font,
                                maxWidth: pageWidth - 100,
                                lineHeight: 18,
                            });
                            
                            const pdfBytes = await pdfDoc.save();
                            download(pdfBytes, `${fileName}.pdf`, "application/pdf");
                            showStatus('Conversion complete! Download started.', 'success', 'word-to-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error converting document: ${e.message}`, 'error', 'word-to-pdf-ui');
                        } finally {
                            showLoader('word-to-pdf-ui', false);
                            disableButton('wordToPdfButton', false);
                        }
                    });
                }
            },
            'edit-pdf': {
                name: 'Edit PDF',
                icon: 'fa-edit',
                description: 'Add text, images, and shapes to your PDF. Draw on pages or highlight important sections.',
                initUI: () => `
                    <div class="tool-section" id="edit-pdf-ui">
                        <h2><i class="fas fa-edit"></i> Edit PDF</h2>
                        <p class="description">${tools['edit-pdf'].description}</p>
                        
                        <div class="dropzone" id="edit-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="editFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="editFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div id="editCanvasContainer" style="margin: 1.5rem 0; display: none;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <div class="button-group">
                                    <button id="addTextButton" class="action-button secondary">
                                        <i class="fas fa-font"></i> Add Text
                                    </button>
                                    <button id="addImageButton" class="action-button secondary">
                                        <i class="fas fa-image"></i> Add Image
                                    </button>
                                </div>
                                <div class="button-group">
                                    <button id="undoButton" class="action-button secondary" disabled>
                                        <i class="fas fa-undo"></i> Undo
                                    </button>
                                    <button id="clearButton" class="action-button secondary">
                                        <i class="fas fa-trash-alt"></i> Clear
                                    </button>
                                </div>
                            </div>
                            
                            <div id="editControls" style="display: none; margin-bottom: 0.5rem;">
                                <div class="input-group">
                                    <div class="form-group">
                                        <label for="editFontSize">Font Size:</label>
                                        <input type="number" id="editFontSize" value="12" min="6" max="72">
                                    </div>
                                    <div class="form-group">
                                        <label for="editColor">Color:</label>
                                        <input type="color" id="editColor" value="#000000">
                                    </div>
                                </div>
                            </div>
                            
                            <canvas id="editCanvas" style="border: 1px solid #ddd; max-width: 100%;"></canvas>
                        </div>
                        
                        <div class="button-group" id="editButtons" style="display: none;">
                            <button id="saveEditedButton" class="action-button">
                                <i class="fas fa-save"></i> Save PDF
                            </button>
                            <button id="cancelEditButton" class="action-button secondary">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                        
                        <div class="loader" id="edit-pdf-ui-loader"></div>
                        <div id="edit-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('editFile');
                    const canvasContainer = document.getElementById('editCanvasContainer');
                    const editControls = document.getElementById('editControls');
                    const editButtons = document.getElementById('editButtons');
                    const canvas = document.getElementById('editCanvas');
                    const ctx = canvas.getContext('2d');
                    let pdfDoc = null;
                    let currentPage = 1;
                    let pageViewport = null;
                    let editMode = null; // 'text' or 'image'
                    let undoStack = [];
                    
                    // Handle drag and drop
                    createDropzone('edit-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            loadPdfForEditing();
                        }
                    });
                    
                    // Handle file selection
                    fileInput.addEventListener('change', () => {
                        if (fileInput.files.length > 0) {
                            loadPdfForEditing();
                        }
                    });
                    
                    // Load PDF for editing
                    async function loadPdfForEditing() {
                        showLoader('edit-pdf-ui', true);
                        disableButton('saveEditedButton', true);
                        showStatus('Loading PDF for editing...', 'info', 'edit-pdf-ui');
                        canvasContainer.style.display = 'none';
                        editButtons.style.display = 'none';
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            pdfDoc = await PDFDocument.load(arrayBuffer);
                            
                            // Load the first page for editing
                            await renderPage(1);
                            
                            canvasContainer.style.display = 'block';
                            editButtons.style.display = 'flex';
                            showStatus('PDF loaded. Use tools above to edit the document.', 'success', 'edit-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error loading PDF: ${e.message}`, 'error', 'edit-pdf-ui');
                        } finally {
                            showLoader('edit-pdf-ui', false);
                            disableButton('saveEditedButton', false);
                        }
                    }
                    
                    // Render a specific page
                    async function renderPage(pageNum) {
                        if (!pdfDoc) return;
                        
                        showLoader('edit-pdf-ui', true);
                        currentPage = pageNum;
                        
                        try {
                            const pdf = await pdfjsLib.getDocument({data: await pdfDoc.save()}).promise;
                            const page = await pdf.getPage(pageNum);
                            pageViewport = page.getViewport({ scale: 1.5 });
                            
                            // Set canvas dimensions
                            canvas.width = pageViewport.width;
                            canvas.height = pageViewport.height;
                            
                            // Render PDF page to canvas
                            await page.render({ 
                                canvasContext: ctx, 
                                viewport: pageViewport 
                            }).promise;
                            
                            // Store initial state for undo
                            saveCanvasState();
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error rendering page: ${e.message}`, 'error', 'edit-pdf-ui');
                        } finally {
                            showLoader('edit-pdf-ui', false);
                        }
                    }
                    
                    // Save current canvas state to undo stack
                    function saveCanvasState() {
                        undoStack.push(canvas.toDataURL());
                        document.getElementById('undoButton').disabled = undoStack.length <= 1;
                    }
                    
                    // Add text button
                    document.getElementById('addTextButton').addEventListener('click', () => {
                        editMode = 'text';
                        editControls.style.display = 'block';
                        canvas.style.cursor = 'text';
                        showStatus('Click on the PDF to add text.', 'info', 'edit-pdf-ui');
                    });
                    
                    // Add image button
                    document.getElementById('addImageButton').addEventListener('click', () => {
                        editMode = 'image';
                        editControls.style.display = 'none';
                        canvas.style.cursor = 'crosshair';
                        
                        // Create a file input for image selection
                        const imageInput = document.createElement('input');
                        imageInput.type = 'file';
                        imageInput.accept = 'image/*';
                        imageInput.style.display = 'none';
                        
                        imageInput.addEventListener('change', async (e) => {
                            if (e.target.files.length > 0) {
                                const imageFile = e.target.files[0];
                                const imageUrl = URL.createObjectURL(imageFile);
                                
                                showStatus('Click on the PDF to place the image.', 'info', 'edit-pdf-ui');
                                
                                // Wait for user to click on canvas to place image
                                const placeImage = (e) => {
                                    const rect = canvas.getBoundingClientRect();
                                    const x = e.clientX - rect.left;
                                    const y = e.clientY - rect.top;
                                    
                                    const img = new Image();
                                    img.onload = () => {
                                        // Draw image at clicked position
                                        ctx.drawImage(img, x, y, 100, 100);
                                        saveCanvasState();
                                        showStatus('Image added. Click "Save PDF" when finished.', 'success', 'edit-pdf-ui');
                                    };
                                    img.src = imageUrl;
                                    
                                    // Remove the event listener after placing the image
                                    canvas.removeEventListener('click', placeImage);
                                };
                                
                                canvas.addEventListener('click', placeImage);
                            }
                        });
                        
                        document.body.appendChild(imageInput);
                        imageInput.click();
                        document.body.removeChild(imageInput);
                    });
                    
                    // Handle canvas clicks for text
                    canvas.addEventListener('click', (e) => {
                        if (editMode !== 'text') return;
                        
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        const text = prompt('Enter text to add:');
                        if (text) {
                            const fontSize = parseInt(document.getElementById('editFontSize').value);
                            const color = document.getElementById('editColor').value;
                            
                            ctx.font = `${fontSize}px Arial`;
                            ctx.fillStyle = color;
                            ctx.fillText(text, x, y);
                            
                            saveCanvasState();
                            showStatus('Text added. Click "Save PDF" when finished.', 'success', 'edit-pdf-ui');
                        }
                    });
                    
                    // Undo button
                    document.getElementById('undoButton').addEventListener('click', () => {
                        if (undoStack.length > 1) {
                            undoStack.pop(); // Remove current state
                            const prevState = undoStack[undoStack.length - 1];
                            
                            const img = new Image();
                            img.onload = () => {
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(img, 0, 0);
                                document.getElementById('undoButton').disabled = undoStack.length <= 1;
                            };
                            img.src = prevState;
                        }
                    });
                    
                    // Clear button
                    document.getElementById('clearButton').addEventListener('click', () => {
                        if (confirm('Clear all edits on this page?')) {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            renderPage(currentPage);
                        }
                    });
                    
                    // Save edited PDF
                    document.getElementById('saveEditedButton').addEventListener('click', async () => {
                        if (!pdfDoc) {
                            showStatus('No PDF loaded to save.', 'error', 'edit-pdf-ui');
                            return;
                        }
                        
                        showLoader('edit-pdf-ui', true);
                        disableButton('saveEditedButton', true);
                        showStatus('Saving edited PDF...', 'info', 'edit-pdf-ui');
                        
                        try {
                            // Get the edited page as an image
                            const imageDataUrl = canvas.toDataURL('image/png');
                            const imageBytes = await fetch(imageDataUrl).then(res => res.arrayBuffer());
                            
                            // Create a new PDF with the edited page
                            const newPdfDoc = await PDFDocument.create();
                            const pngImage = await newPdfDoc.embedPng(imageBytes);
                            
                            // Add the edited page
                            const page = newPdfDoc.addPage([pngImage.width, pngImage.height]);
                            page.drawImage(pngImage, {
                                x: 0,
                                y: 0,
                                width: pngImage.width,
                                height: pngImage.height,
                            });
                            
                            const newPdfBytes = await newPdfDoc.save();
                            download(newPdfBytes, "edited.pdf", "application/pdf");
                            showStatus('Edited PDF saved successfully! Download started.', 'success', 'edit-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error saving edited PDF: ${e.message}`, 'error', 'edit-pdf-ui');
                        } finally {
                            showLoader('edit-pdf-ui', false);
                            disableButton('saveEditedButton', false);
                        }
                    });
                    
                    // Cancel editing
                    document.getElementById('cancelEditButton').addEventListener('click', () => {
                        if (confirm('Cancel all edits and reload original PDF?')) {
                            loadPdfForEditing();
                        }
                    });
                }
            },
            'remove-pages': {
                name: 'Remove Pages',
                icon: 'fa-minus-circle',
                description: 'Delete specific pages from a PDF file. Select pages to remove and save the remaining ones.',
                initUI: () => `
                    <div class="tool-section" id="remove-pages-ui">
                        <h2><i class="fas fa-minus-circle"></i> Remove Pages</h2>
                        <p class="description">${tools['remove-pages'].description}</p>
                        
                        <div class="dropzone" id="remove-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="removeFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="removeFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div id="removeThumbnailsContainer" style="margin: 1.5rem 0; display: none;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Select Pages to Remove</h3>
                            <div id="removeThumbnails" class="page-thumbnails"></div>
                        </div>
                        
                        <div class="button-group" id="removeButtons" style="display: none;">
                            <button id="saveRemovedButton" class="action-button">
                                <i class="fas fa-save"></i> Save PDF
                            </button>
                            <button id="selectAllButton" class="action-button secondary">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                        </div>
                        
                        <div class="loader" id="remove-pages-ui-loader"></div>
                        <div id="remove-pages-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('removeFile');
                    const thumbnailsContainer = document.getElementById('removeThumbnailsContainer');
                    const thumbnails = document.getElementById('removeThumbnails');
                    const removeButtons = document.getElementById('removeButtons');
                    let pdfDoc = null;
                    let pagesToRemove = [];
                    
                    // Handle drag and drop
                    createDropzone('remove-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            loadPdfForRemoval();
                        }
                    });
                    
                    // Handle file selection
                    fileInput.addEventListener('change', () => {
                        if (fileInput.files.length > 0) {
                            loadPdfForRemoval();
                        }
                    });
                    
                    // Load PDF and generate thumbnails
                    async function loadPdfForRemoval() {
                        showLoader('remove-pages-ui', true);
                        disableButton('saveRemovedButton', true);
                        disableButton('selectAllButton', true);
                        showStatus('Loading PDF...', 'info', 'remove-pages-ui');
                        thumbnails.innerHTML = '';
                        pagesToRemove = [];
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            pdfDoc = await PDFDocument.load(arrayBuffer);
                            const numPages = pdfDoc.getPageCount();
                            
                            // Generate thumbnails
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            const previewPageCount = Math.min(numPages, 20); // Limit to first 20 pages for performance
                            
                            for (let i = 1; i <= previewPageCount; i++) {
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale: 0.5 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                
                                const thumbnail = document.createElement('div');
                                thumbnail.className = 'page-thumbnail';
                                thumbnail.dataset.index = i - 1;
                                
                                const img = document.createElement('img');
                                img.src = canvas.toDataURL('image/jpeg', 0.7);
                                img.alt = `Page ${i}`;
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = `remove-page-${i}`;
                                checkbox.style.position = 'absolute';
                                checkbox.style.top = '5px';
                                checkbox.style.right = '5px';
                                checkbox.addEventListener('change', (e) => {
                                    const pageIndex = parseInt(thumbnail.dataset.index);
                                    if (e.target.checked) {
                                        pagesToRemove.push(pageIndex);
                                    } else {
                                        pagesToRemove = pagesToRemove.filter(idx => idx !== pageIndex);
                                    }
                                });
                                
                                const pageNum = document.createElement('div');
                                pageNum.className = 'page-number';
                                pageNum.textContent = i;
                                
                                thumbnail.appendChild(checkbox);
                                thumbnail.appendChild(pageNum);
                                thumbnail.appendChild(img);
                                thumbnails.appendChild(thumbnail);
                                
                                canvas.remove();
                            }
                            
                            if (numPages > 20) {
                                thumbnails.innerHTML += `<div style="text-align: center; font-style: italic;">+ ${numPages - 20} more pages...</div>`;
                            }
                            
                            thumbnailsContainer.style.display = 'block';
                            removeButtons.style.display = 'flex';
                            disableButton('saveRemovedButton', false);
                            disableButton('selectAllButton', false);
                            showStatus('Select pages to remove, then click "Save PDF".', 'success', 'remove-pages-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error loading PDF: ${e.message}`, 'error', 'remove-pages-ui');
                        } finally {
                            showLoader('remove-pages-ui', false);
                        }
                    }
                    
                    // Select all button
                    document.getElementById('selectAllButton').addEventListener('click', () => {
                        const checkboxes = thumbnails.querySelectorAll('input[type="checkbox"]');
                        const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                        
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = !allChecked;
                            const event = new Event('change');
                            checkbox.dispatchEvent(event);
                        });
                        
                        showStatus(allChecked ? 'All pages deselected.' : 'All pages selected for removal.', 'info', 'remove-pages-ui');
                    });
                    
                    // Save PDF with removed pages
                    document.getElementById('saveRemovedButton').addEventListener('click', async () => {
                        if (!pdfDoc) {
                            showStatus('No PDF loaded to save.', 'error', 'remove-pages-ui');
                            return;
                        }
                        
                        if (pagesToRemove.length === 0) {
                            showStatus('No pages selected for removal.', 'error', 'remove-pages-ui');
                            return;
                        }
                        
                        showLoader('remove-pages-ui', true);
                        disableButton('saveRemovedButton', true);
                        showStatus('Saving PDF with pages removed...', 'info', 'remove-pages-ui');
                        
                        try {
                            // Create a new PDF with the remaining pages
                            const newPdfDoc = await PDFDocument.create();
                            const allPageIndices = Array.from({ length: pdfDoc.getPageCount() }, (_, i) => i);
                            const pagesToKeep = allPageIndices.filter(idx => !pagesToRemove.includes(idx));
                            
                            if (pagesToKeep.length === 0) {
                                throw new Error('Cannot remove all pages from a PDF.');
                            }
                            
                            const copiedPages = await newPdfDoc.copyPages(pdfDoc, pagesToKeep);
                            copiedPages.forEach(page => newPdfDoc.addPage(page));
                            
                            const newPdfBytes = await newPdfDoc.save();
                            download(newPdfBytes, "removed_pages.pdf", "application/pdf");
                            showStatus(`PDF saved with ${pagesToRemove.length} pages removed. Download started.`, 'success', 'remove-pages-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error saving PDF: ${e.message}`, 'error', 'remove-pages-ui');
                        } finally {
                            showLoader('remove-pages-ui', false);
                            disableButton('saveRemovedButton', false);
                        }
                    });
                }
            },
            'rotate-pdf': {
                name: 'Rotate PDF',
                icon: 'fa-sync',
                description: 'Rotate all pages or selected pages in a PDF document by 90, 180, or 270 degrees.',
                initUI: () => `
                    <div class="tool-section" id="rotate-pdf-ui">
                        <h2><i class="fas fa-sync"></i> Rotate PDF</h2>
                        <p class="description">${tools['rotate-pdf'].description}</p>
                        
                        <div class="dropzone" id="rotate-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="rotateFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="rotateFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="rotateDegrees">Rotation:</label>
                            <select id="rotateDegrees">
                                <option value="90">90° Clockwise</option>
                                <option value="180">180°</option>
                                <option value="270">90° Counter-Clockwise</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="rotatePages">Pages to Rotate:</label>
                            <select id="rotatePages">
                                <option value="all">All Pages</option>
                                <option value="odd">Odd Pages Only</option>
                                <option value="even">Even Pages Only</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="rotateCustomGroup" style="display: none;">
                            <label for="rotateCustomRange">Page Range (e.g., 1-3,5,7-9):</label>
                            <input type="text" id="rotateCustomRange" placeholder="e.g., 1-3,5,7-9">
                        </div>
                        
                        <button id="rotateButton" class="action-button">
                            <i class="fas fa-redo"></i> Rotate PDF
                        </button>
                        
                        <div class="loader" id="rotate-pdf-ui-loader"></div>
                        <div id="rotate-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('rotateFile');
                    const rotatePagesSelect = document.getElementById('rotatePages');
                    const rotateCustomGroup = document.getElementById('rotateCustomGroup');
                    
                    // Handle drag and drop
                    createDropzone('rotate-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'rotate-pdf-ui');
                        }
                    });
                    
                    // Show/hide custom range field
                    rotatePagesSelect.addEventListener('change', () => {
                        rotateCustomGroup.style.display = rotatePagesSelect.value === 'custom' ? 'block' : 'none';
                    });
                    
                    // Rotate button
                    document.getElementById('rotateButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'rotate-pdf-ui');
                            return;
                        }
                        
                        const degrees = parseInt(document.getElementById('rotateDegrees').value);
                        const pagesOption = document.getElementById('rotatePages').value;
                        const customRange = document.getElementById('rotateCustomRange').value;
                        
                        showLoader('rotate-pdf-ui', true);
                        disableButton('rotateButton', true);
                        showStatus('Rotating PDF pages...', 'info', 'rotate-pdf-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdfDoc = await PDFDocument.load(arrayBuffer);
                            const numPages = pdfDoc.getPageCount();
                            
                            // Determine which pages to rotate
                            let pagesToRotate = [];
                            
                            if (pagesOption === 'all') {
                                pagesToRotate = Array.from({ length: numPages }, (_, i) => i);
                            } else if (pagesOption === 'odd') {
                                pagesToRotate = Array.from({ length: numPages }, (_, i) => i)
                                    .filter(idx => (idx + 1) % 2 !== 0);
                            } else if (pagesOption === 'even') {
                                pagesToRotate = Array.from({ length: numPages }, (_, i) => i)
                                    .filter(idx => (idx + 1) % 2 === 0);
                            } else if (pagesOption === 'custom' && customRange) {
                                const ranges = customRange.split(',');
                                for (const range of ranges) {
                                    const trimmedRange = range.trim();
                                    if (trimmedRange.includes('-')) {
                                        let [start, end] = trimmedRange.split('-');
                                        start = parseInt(start, 10);
                                        end = parseInt(end, 10);
                                        if (isNaN(start) || isNaN(end) || start < 1 || end > numPages || start > end) {
                                            throw new Error(`Invalid range: ${trimmedRange}. Max page is ${numPages}.`);
                                        }
                                        for (let i = start; i <= end; i++) {
                                            pagesToRotate.push(i - 1); // 0-indexed
                                        }
                                    } else {
                                        const pageNum = parseInt(trimmedRange, 10);
                                        if (isNaN(pageNum) || pageNum < 1 || pageNum > numPages) {
                                            throw new Error(`Invalid page number: ${trimmedRange}. Max page is ${numPages}.`);
                                        }
                                        pagesToRotate.push(pageNum - 1); // 0-indexed
                                    }
                                }
                            } else if (pagesOption === 'custom') {
                                throw new Error('Please enter a page range for custom rotation.');
                            }
                            
                            // Rotate the selected pages
                            for (const pageIndex of pagesToRotate) {
                                const page = pdfDoc.getPage(pageIndex);
                                const currentRotation = page.node.Rotate() || 0;
                                page.setRotation(degrees(currentRotation + degrees));
                            }
                            
                            const rotatedPdfBytes = await pdfDoc.save();
                            download(rotatedPdfBytes, "rotated.pdf", "application/pdf");
                            showStatus(`PDF rotated successfully! ${pagesToRotate.length} pages affected.`, 'success', 'rotate-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error rotating PDF: ${e.message}`, 'error', 'rotate-pdf-ui');
                        } finally {
                            showLoader('rotate-pdf-ui', false);
                            disableButton('rotateButton', false);
                        }
                    });
                }
            },
            'watermark-pdf': {
                name: 'Watermark PDF',
                icon: 'fa-stamp',
                description: 'Add text or image watermarks to your PDF document. Customize position, opacity, and rotation.',
                initUI: () => `
                    <div class="tool-section" id="watermark-pdf-ui">
                        <h2><i class="fas fa-stamp"></i> Watermark PDF</h2>
                        <p class="description">${tools['watermark-pdf'].description}</p>
                        
                        <div class="dropzone" id="watermark-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="watermarkFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="watermarkFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="watermarkType">Watermark Type:</label>
                            <select id="watermarkType">
                                <option value="text">Text Watermark</option>
                                <option value="image">Image Watermark</option>
                            </select>
                        </div>
                        
                        <div id="textWatermarkOptions">
                            <div class="form-group">
                                <label for="watermarkText">Watermark Text:</label>
                                <input type="text" id="watermarkText" placeholder="e.g., CONFIDENTIAL">
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="watermarkFontSize">Font Size:</label>
                                    <input type="number" id="watermarkFontSize" value="48" min="8" max="120">
                                </div>
                                
                                <div class="form-group">
                                    <label for="watermarkColor">Color:</label>
                                    <input type="color" id="watermarkColor" value="#999999">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="watermarkFont">Font:</label>
                                <select id="watermarkFont">
                                    <option value="Helvetica-Bold">Helvetica Bold</option>
                                    <option value="Times-Bold">Times Bold</option>
                                    <option value="Courier-Bold">Courier Bold</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="imageWatermarkOptions" style="display: none;">
                            <div class="form-group">
                                <label for="watermarkImage">Watermark Image:</label>
                                <input type="file" id="watermarkImage" accept="image/*" style="display: none;">
                                <label for="watermarkImage" class="action-button secondary" style="cursor: pointer; display: inline-block; margin-bottom: 1rem;">
                                    <i class="fas fa-image"></i> Select Image
                                </label>
                                <div id="watermarkImagePreview" style="margin-top: 0.5rem;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="watermarkOpacity">Opacity:</label>
                            <input type="range" id="watermarkOpacity" min="0.1" max="1.0" step="0.1" value="0.5">
                            <div class="range-labels">
                                <span>Faint</span>
                                <span>Medium</span>
                                <span>Dark</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="watermarkRotation">Rotation (degrees):</label>
                            <input type="number" id="watermarkRotation" value="45" min="0" max="360">
                        </div>
                        
                        <div class="form-group">
                            <label for="watermarkPosition">Position:</label>
                            <select id="watermarkPosition">
                                <option value="center">Center</option>
                                <option value="tiled">Tiled (Repeated)</option>
                                <option value="top-left">
                                    <option value="top-right">Top Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="bottom-right">Bottom Right</option>
                            </select>
                        </div>
                        
                        <button id="watermarkButton" class="action-button">
                            <i class="fas fa-stamp"></i> Apply Watermark
                        </button>
                        
                        <div class="loader" id="watermark-pdf-ui-loader"></div>
                        <div id="watermark-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('watermarkFile');
                    const watermarkType = document.getElementById('watermarkType');
                    const textOptions = document.getElementById('textWatermarkOptions');
                    const imageOptions = document.getElementById('imageWatermarkOptions');
                    const watermarkImageInput = document.getElementById('watermarkImage');
                    const imagePreview = document.getElementById('watermarkImagePreview');
                    let watermarkImage = null;
                    
                    // Handle drag and drop for main PDF
                    createDropzone('watermark-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'watermark-pdf-ui');
                        }
                    });
                    
                    // Handle watermark type change
                    watermarkType.addEventListener('change', () => {
                        if (watermarkType.value === 'text') {
                            textOptions.style.display = 'block';
                            imageOptions.style.display = 'none';
                        } else {
                            textOptions.style.display = 'none';
                            imageOptions.style.display = 'block';
                        }
                    });
                    
                    // Handle watermark image selection
                    watermarkImageInput.addEventListener('change', async () => {
                        if (watermarkImageInput.files.length > 0) {
                            const file = watermarkImageInput.files[0];
                            const reader = new FileReader();
                            
                            reader.onload = (e) => {
                                imagePreview.innerHTML = '';
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.maxWidth = '200px';
                                img.style.maxHeight = '200px';
                                imagePreview.appendChild(img);
                                watermarkImage = file;
                            };
                            
                            reader.readAsDataURL(file);
                            showStatus('Watermark image selected.', 'success', 'watermark-pdf-ui');
                        }
                    });
                    
                    // Apply watermark button
                    document.getElementById('watermarkButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'watermark-pdf-ui');
                            return;
                        }
                        
                        if (watermarkType.value === 'image' && !watermarkImage) {
                            showStatus('Please select a watermark image.', 'error', 'watermark-pdf-ui');
                            return;
                        }
                        
                        const opacity = parseFloat(document.getElementById('watermarkOpacity').value);
                        const rotation = parseInt(document.getElementById('watermarkRotation').value);
                        const position = document.getElementById('watermarkPosition').value;
                        
                        showLoader('watermark-pdf-ui', true);
                        disableButton('watermarkButton', true);
                        showStatus('Applying watermark...', 'info', 'watermark-pdf-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            const pdfDoc = await PDFDocument.load(arrayBuffer);
                            const pages = pdfDoc.getPages();
                            
                            if (watermarkType.value === 'text') {
                                const text = document.getElementById('watermarkText').value;
                                const fontSize = parseInt(document.getElementById('watermarkFontSize').value);
                                const colorHex = document.getElementById('watermarkColor').value;
                                const fontType = document.getElementById('watermarkFont').value;
                                
                                // Convert hex color to RGB with opacity
                                const r = parseInt(colorHex.substr(1, 2), 16) / 255;
                                const g = parseInt(colorHex.substr(3, 2), 16) / 255;
                                const b = parseInt(colorHex.substr(5, 2), 16) / 255;
                                
                                const font = await pdfDoc.embedFont(StandardFonts[fontType]);
                                
                                for (const page of pages) {
                                    const { width, height } = page.getSize();
                                    const textWidth = font.widthOfTextAtSize(text, fontSize);
                                    
                                    if (position === 'tiled') {
                                        // Calculate how many watermarks fit horizontally and vertically
                                        const cols = Math.ceil(width / (textWidth * 1.5));
                                        const rows = Math.ceil(height / (fontSize * 2));
                                        
                                        for (let row = 0; row < rows; row++) {
                                            for (let col = 0; col < cols; col++) {
                                                const x = col * (textWidth * 1.5);
                                                const y = row * (fontSize * 2);
                                                
                                                page.drawText(text, {
                                                    x,
                                                    y,
                                                    size: fontSize,
                                                    font,
                                                    color: rgb(r, g, b, opacity),
                                                    rotate: degrees(rotation),
                                                });
                                            }
                                        }
                                    } else {
                                        let x, y;
                                        
                                        switch(position) {
                                            case 'center':
                                                x = width / 2 - textWidth / 2;
                                                y = height / 2;
                                                break;
                                            case 'top-left':
                                                x = width * 0.1;
                                                y = height * 0.9;
                                                break;
                                            case 'top-right':
                                                x = width * 0.9 - textWidth;
                                                y = height * 0.9;
                                                break;
                                            case 'bottom-left':
                                                x = width * 0.1;
                                                y = height * 0.1;
                                                break;
                                            case 'bottom-right':
                                                x = width * 0.9 - textWidth;
                                                y = height * 0.1;
                                                break;
                                            default:
                                                x = width / 2 - textWidth / 2;
                                                y = height / 2;
                                        }
                                        
                                        page.drawText(text, {
                                            x,
                                            y,
                                            size: fontSize,
                                            font,
                                            color: rgb(r, g, b, opacity),
                                            rotate: degrees(rotation),
                                        });
                                    }
                                }
                            } else {
                                // Image watermark
                                const imageArrayBuffer = await watermarkImage.arrayBuffer();
                                let image;
                                
                                if (watermarkImage.type === 'image/png') {
                                    image = await pdfDoc.embedPng(imageArrayBuffer);
                                } else {
                                    image = await pdfDoc.embedJpg(imageArrayBuffer);
                                }
                                
                                for (const page of pages) {
                                    const { width, height } = page.getSize();
                                    
                                    if (position === 'tiled') {
                                        // Calculate how many watermarks fit horizontally and vertically
                                        const cols = Math.ceil(width / (image.width * 0.5));
                                        const rows = Math.ceil(height / (image.height * 0.5));
                                        
                                        for (let row = 0; row < rows; row++) {
                                            for (let col = 0; col < cols; col++) {
                                                const x = col * (image.width * 0.5);
                                                const y = row * (image.height * 0.5);
                                                
                                                page.drawImage(image, {
                                                    x,
                                                    y,
                                                    width: image.width * 0.5,
                                                    height: image.height * 0.5,
                                                    opacity,
                                                    rotate: degrees(rotation),
                                                });
                                            }
                                        }
                                    } else {
                                        let x, y, drawWidth, drawHeight;
                                        
                                        // Scale image to be about 30% of page width while maintaining aspect ratio
                                        const scale = (width * 0.3) / image.width;
                                        drawWidth = image.width * scale;
                                        drawHeight = image.height * scale;
                                        
                                        switch(position) {
                                            case 'center':
                                                x = width / 2 - drawWidth / 2;
                                                y = height / 2 - drawHeight / 2;
                                                break;
                                            case 'top-left':
                                                x = width * 0.1;
                                                y = height * 0.9 - drawHeight;
                                                break;
                                            case 'top-right':
                                                x = width * 0.9 - drawWidth;
                                                y = height * 0.9 - drawHeight;
                                                break;
                                            case 'bottom-left':
                                                x = width * 0.1;
                                                y = height * 0.1;
                                                break;
                                            case 'bottom-right':
                                                x = width * 0.9 - drawWidth;
                                                y = height * 0.1;
                                                break;
                                            default:
                                                x = width / 2 - drawWidth / 2;
                                                y = height / 2 - drawHeight / 2;
                                        }
                                        
                                        page.drawImage(image, {
                                            x,
                                            y,
                                            width: drawWidth,
                                            height: drawHeight,
                                            opacity,
                                            rotate: degrees(rotation),
                                        });
                                    }
                                }
                            }
                            
                            const watermarkedPdfBytes = await pdfDoc.save();
                            download(watermarkedPdfBytes, "watermarked.pdf", "application/pdf");
                            showStatus('Watermark applied successfully! Download started.', 'success', 'watermark-pdf-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error applying watermark: ${e.message}`, 'error', 'watermark-pdf-ui');
                        } finally {
                            showLoader('watermark-pdf-ui', false);
                            disableButton('watermarkButton', false);
                        }
                    });
                }
            },
            'repair-pdf': {
                name: 'Repair PDF',
                icon: 'fa-wrench',
                description: 'Attempt to repair corrupted or damaged PDF files. This may recover some content from unreadable PDFs.',
                initUI: () => `
                    <div class="tool-section" id="repair-pdf-ui">
                        <h2><i class="fas fa-wrench"></i> Repair PDF</h2>
                        <p class="description">${tools['repair-pdf'].description}</p>
                        
                        <div class="dropzone" id="repair-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="repairFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="repairFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label for="repairMode">Repair Mode:</label>
                            <select id="repairMode">
                                <option value="basic">Basic Repair</option>
                                <option value="advanced">Advanced Repair</option>
                            </select>
                        </div>
                        
                        <button id="repairButton" class="action-button">
                            <i class="fas fa-magic"></i> Repair PDF
                        </button>
                        
                        <div class="loader" id="repair-pdf-ui-loader"></div>
                        <div id="repair-pdf-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('repairFile');
                    
                    // Handle drag and drop
                    createDropzone('repair-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            showStatus('File ready for processing.', 'success', 'repair-pdf-ui');
                        }
                    });
                    
                    // Repair button
                    document.getElementById('repairButton').addEventListener('click', async () => {
                        if (!fileInput.files.length) {
                            showStatus('Please select a PDF file.', 'error', 'repair-pdf-ui');
                            return;
                        }
                        
                        const mode = document.getElementById('repairMode').value;
                        
                        showLoader('repair-pdf-ui', true);
                        disableButton('repairButton', true);
                        showStatus('Attempting to repair PDF...', 'info', 'repair-pdf-ui');
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            
                            // Attempt to load the PDF with different options
                            let pdfDoc;
                            try {
                                if (mode === 'basic') {
                                    pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                                } else {
                                    // Advanced repair attempts more aggressive recovery
                                    pdfDoc = await PDFDocument.load(arrayBuffer, {
                                        ignoreEncryption: true,
                                        throwOnInvalidObject: false,
                                        updateMetadata: false
                                    });
                                }
                                
                                // Rebuild the PDF document
                                const repairedPdfBytes = await pdfDoc.save();
                                download(repairedPdfBytes, "repaired.pdf", "application/pdf");
                                showStatus('PDF repair attempted. Download started.', 'success', 'repair-pdf-ui');
                            } catch (loadError) {
                                // If we couldn't load it normally, try to extract what we can
                                showStatus('Unable to fully repair the PDF. Attempting to extract recoverable content...', 'warning', 'repair-pdf-ui');
                                
                                const newPdfDoc = await PDFDocument.create();
                                try {
                                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer, ignoreErrors: true}).promise;
                                    const numPages = pdf.numPages;
                                    
                                    for (let i = 1; i <= numPages; i++) {
                                        try {
                                            const page = await pdf.getPage(i);
                                            const viewport = page.getViewport({ scale: 1.0 });
                                            const canvas = document.createElement('canvas');
                                            const context = canvas.getContext('2d');
                                            canvas.height = viewport.height;
                                            canvas.width = viewport.width;
                                            
                                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                                            
                                            // Add the rendered page as an image to the new PDF
                                            const imageBytes = await new Promise(resolve => {
                                                canvas.toBlob(blob => {
                                                    const reader = new FileReader();
                                                    reader.onload = () => resolve(reader.result);
                                                    reader.readAsArrayBuffer(blob);
                                                }, 'image/jpeg', 0.8);
                                            });
                                            
                                            const image = await newPdfDoc.embedJpg(imageBytes);
                                            const newPage = newPdfDoc.addPage([image.width, image.height]);
                                            newPage.drawImage(image, {
                                                x: 0,
                                                y: 0,
                                                width: image.width,
                                                height: image.height,
                                            });
                                            
                                            canvas.remove();
                                        } catch (pageError) {
                                            console.error(`Error processing page ${i}:`, pageError);
                                            continue;
                                        }
                                    }
                                    
                                    const recoveredPdfBytes = await newPdfDoc.save();
                                    download(recoveredPdfBytes, "recovered.pdf", "application/pdf");
                                    showStatus('Recovered content saved as new PDF. Some formatting may be lost.', 'success', 'repair-pdf-ui');
                                } catch (recoveryError) {
                                    console.error(recoveryError);
                                    throw new Error('Unable to recover any content from the PDF.');
                                }
                            }
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error repairing PDF: ${e.message}`, 'error', 'repair-pdf-ui');
                        } finally {
                            showLoader('repair-pdf-ui', false);
                            disableButton('repairButton', false);
                        }
                    });
                }
            },
            'pdf-metadata': {
                name: 'PDF Metadata',
                icon: 'fa-info-circle',
                description: 'View and edit PDF metadata including title, author, keywords, and more. Remove sensitive metadata before sharing.',
                initUI: () => `
                    <div class="tool-section" id="pdf-metadata-ui">
                        <h2><i class="fas fa-info-circle"></i> PDF Metadata</h2>
                        <p class="description">${tools['pdf-metadata'].description}</p>
                        
                        <div class="dropzone" id="metadata-dropzone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop a PDF file here</p>
                            <p>or</p>
                            <label for="metadataFile" class="action-button" style="cursor: pointer; display: inline-block;">
                                <i class="fas fa-folder-open"></i> Select File
                            </label>
                            <input type="file" id="metadataFile" accept=".pdf" style="display: none;">
                        </div>
                        
                        <div id="metadataDisplay" style="margin: 1.5rem 0; display: none;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Document Metadata</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold; width: 30%;">Title:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataTitle"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold;">Author:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataAuthor"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold;">Subject:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataSubject"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold;">Keywords:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataKeywords"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold;">Creator:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataCreator"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold;">Producer:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataProducer"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold;">Created:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataCreated"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee; font-weight: bold;">Modified:</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;" id="metadataModified"></td>
                                </tr>
                            </table>
                            
                            <div style="margin-top: 1.5rem;">
                                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Edit Metadata</h3>
                                <div class="form-group">
                                    <label for="editTitle">Title:</label>
                                    <input type="text" id="editTitle">
                                </div>
                                <div class="form-group">
                                    <label for="editAuthor">Author:</label>
                                    <input type="text" id="editAuthor">
                                </div>
                                <div class="form-group">
                                    <label for="editSubject">Subject:</label>
                                    <input type="text" id="editSubject">
                                </div>
                                <div class="form-group">
                                    <label for="editKeywords">Keywords (comma separated):</label>
                                    <input type="text" id="editKeywords">
                                </div>
                            </div>
                        </div>
                        
                        <div class="button-group" id="metadataButtons" style="display: none;">
                            <button id="saveMetadataButton" class="action-button">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button id="clearMetadataButton" class="action-button secondary">
                                <i class="fas fa-eraser"></i> Clear Metadata
                            </button>
                        </div>
                        
                        <div class="loader" id="pdf-metadata-ui-loader"></div>
                        <div id="pdf-metadata-ui-status" class="status-message" style="display:none;"></div>
                    </div>
                `,
                attachListeners: () => {
                    const fileInput = document.getElementById('metadataFile');
                    const metadataDisplay = document.getElementById('metadataDisplay');
                    const metadataButtons = document.getElementById('metadataButtons');
                    let pdfDoc = null;
                    
                    // Handle drag and drop
                    createDropzone('metadata-dropzone', (droppedFiles) => {
                        if (droppedFiles.length > 0) {
                            fileInput.files = droppedFiles;
                            loadPdfMetadata();
                        }
                    });
                    
                    // Handle file selection
                    fileInput.addEventListener('change', () => {
                        if (fileInput.files.length > 0) {
                            loadPdfMetadata();
                        }
                    });
                    
                    // Load PDF and display metadata
                    async function loadPdfMetadata() {
                        showLoader('pdf-metadata-ui', true);
                        disableButton('saveMetadataButton', true);
                        disableButton('clearMetadataButton', true);
                        showStatus('Loading PDF metadata...', 'info', 'pdf-metadata-ui');
                        metadataDisplay.style.display = 'none';
                        metadataButtons.style.display = 'none';
                        
                        try {
                            const arrayBuffer = await fileInput.files[0].arrayBuffer();
                            pdfDoc = await PDFDocument.load(arrayBuffer);
                            
                            // Display current metadata
                            const metadata = pdfDoc.getTitle() || {};
                            document.getElementById('metadataTitle').textContent = metadata.title || 'N/A';
                            document.getElementById('metadataAuthor').textContent = metadata.author || 'N/A';
                            document.getElementById('metadataSubject').textContent = metadata.subject || 'N/A';
                            document.getElementById('metadataKeywords').textContent = metadata.keywords || 'N/A';
                            document.getElementById('metadataCreator').textContent = metadata.creator || 'N/A';
                            document.getElementById('metadataProducer').textContent = metadata.producer || 'N/A';
                            document.getElementById('metadataCreated').textContent = metadata.creationDate ? new Date(metadata.creationDate).toString() : 'N/A';
                            document.getElementById('metadataModified').textContent = metadata.modDate ? new Date(metadata.modDate).toString() : 'N/A';
                            
                            // Set editable fields
                            document.getElementById('editTitle').value = metadata.title || '';
                            document.getElementById('editAuthor').value = metadata.author || '';
                            document.getElementById('editSubject').value = metadata.subject || '';
                            document.getElementById('editKeywords').value = metadata.keywords || '';
                            
                            metadataDisplay.style.display = 'block';
                            metadataButtons.style.display = 'flex';
                            disableButton('saveMetadataButton', false);
                            disableButton('clearMetadataButton', false);
                            showStatus('Metadata loaded. Edit fields below.', 'success', 'pdf-metadata-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error loading PDF metadata: ${e.message}`, 'error', 'pdf-metadata-ui');
                        } finally {
                            showLoader('pdf-metadata-ui', false);
                        }
                    }
                    
                    // Save metadata changes
                    document.getElementById('saveMetadataButton').addEventListener('click', async () => {
                        if (!pdfDoc) {
                            showStatus('No PDF loaded to save.', 'error', 'pdf-metadata-ui');
                            return;
                        }
                        
                        showLoader('pdf-metadata-ui', true);
                        disableButton('saveMetadataButton', true);
                        showStatus('Saving metadata changes...', 'info', 'pdf-metadata-ui');
                        
                        try {
                            const title = document.getElementById('editTitle').value;
                            const author = document.getElementById('editAuthor').value;
                            const subject = document.getElementById('editSubject').value;
                            const keywords = document.getElementById('editKeywords').value;
                            
                            pdfDoc.setTitle(title);
                            pdfDoc.setAuthor(author);
                            pdfDoc.setSubject(subject);
                            pdfDoc.setKeywords(keywords);
                            pdfDoc.setModificationDate(new Date());
                            
                            const updatedPdfBytes = await pdfDoc.save();
                            download(updatedPdfBytes, "metadata_updated.pdf", "application/pdf");
                            showStatus('Metadata updated successfully! Download started.', 'success', 'pdf-metadata-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error updating metadata: ${e.message}`, 'error', 'pdf-metadata-ui');
                        } finally {
                            showLoader('pdf-metadata-ui', false);
                            disableButton('saveMetadataButton', false);
                        }
                    });
                    
                    // Clear metadata
                    document.getElementById('clearMetadataButton').addEventListener('click', async () => {
                        if (!pdfDoc) {
                            showStatus('No PDF loaded to clear.', 'error', 'pdf-metadata-ui');
                            return;
                        }
                        
                        if (!confirm('Remove all metadata from this PDF? This cannot be undone.')) {
                            return;
                        }
                        
                        showLoader('pdf-metadata-ui', true);
                        disableButton('clearMetadataButton', true);
                        showStatus('Clearing metadata...', 'info', 'pdf-metadata-ui');
                        
                        try {
                            // Create a new PDF with the same content but no metadata
                            const newPdfDoc = await PDFDocument.create();
                            const pages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
                            pages.forEach(page => newPdfDoc.addPage(page));
                            
                            const cleanedPdfBytes = await newPdfDoc.save();
                            download(cleanedPdfBytes, "cleaned_metadata.pdf", "application/pdf");
                            showStatus('Metadata cleared successfully! Download started.', 'success', 'pdf-metadata-ui');
                        } catch (e) {
                            console.error(e);
                            showStatus(`Error clearing metadata: ${e.message}`, 'error', 'pdf-metadata-ui');
                        } finally {
                            showLoader('pdf-metadata-ui', false);
                            disableButton('clearMetadataButton', false);
                        }
                    });
                }
            }
        };

        // --- Tool Loading and Navigation ---
        function loadTool(toolKey) {
            if (tools[toolKey]) {
                toolContainer.innerHTML = tools[toolKey].initUI();
                if (typeof tools[toolKey].attachListeners === 'function') {
                    tools[toolKey].attachListeners();
                }
                localStorage.setItem('lastTool', toolKey);
                currentTool = toolKey; // Keep track for status updates etc.

                // Update active button
                Array.from(toolNavigation.children).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.toolKey === toolKey);
                });

            } else {
                toolContainer.innerHTML = '<div class="tool-section"><h2>Tool Not Found</h2><p>The requested tool is not available.</p></div>';
            }
        }

        // Create tool navigation buttons
        Object.keys(tools).forEach(key => {
            const button = document.createElement('button');
            button.innerHTML = `<i class="fas ${tools[key].icon}"></i> ${tools[key].name}`;
            button.dataset.toolKey = key;
            button.addEventListener('click', () => loadTool(key));
            toolNavigation.appendChild(button);
        });

        // Load last used tool or first tool
        const lastTool = localStorage.getItem('lastTool');
        if (lastTool && tools[lastTool]) {
            loadTool(lastTool);
        } else if (Object.keys(tools).length > 0) {
            loadTool(Object.keys(tools)[0]); // Load the first tool by default
        }

        // Handle service worker registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    })();
    </script>
</body>
</html>
